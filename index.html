<!DOCTYPE html><html dir="rtl" lang="ar"><head><meta charset="utf-8"/><meta content="width=device-width,initial-scale=1" name="viewport"/><title>عروض نفـــــيسه !</title><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&amp;display=swap" rel="stylesheet"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/><style> :root { --primary-color: #aa5555; --secondary-color: #FF9800; --accent-color: #4CAF50; --accent-color-dark: #45a049; --danger-color: #F44336; --background-color: #F8F9FA; --surface-color: #FFFFFF; --text-color: #212529; --subtle-text-color: #6C757D; --border-color: #DEE2E6; --sidebar-bg: #343A40; --sidebar-text: #DEE2E6; --shadow: 0 4px 12px rgba(0, 0, 0, .1); --transition-speed: .3s; --button-grey: #E0E0E0; --button-grey-hover: #B0B0B0; --light-green: #90EE90; --sky-blue: #87CEEB; --pink: #FFC0CB } body { font-family: Cairo, sans-serif; line-height: 1.6; margin: 0; background-color: var(--background-color); color: var(--text-color); direction: rtl; text-align: right; padding-top: 50px; padding-bottom: 60px; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none } input, textarea { -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; user-select: text } button, input, select, textarea { font-family: Cairo, sans-serif } header { text-align: center; margin-bottom: 30px } header h1 { text-align: center; color: var(--primary-color); margin-bottom: 0; padding-top: 0; font-size: 2.5rem; font-weight: 700 } @media (max-width:768px) { header { margin-bottom: 20px } header h1 { font-size: 2rem; margin-bottom: 0 } } .sub-heading { text-align: center; color: var(--subtle-text-color); margin-top: 5px; margin-bottom: 30px; font-size: 1.3rem; font-weight: 400 } @media (max-width:768px) { .sub-heading { margin-top: 3px; margin-bottom: 20px; font-size: 1.1rem } } #topControlsBar { position: fixed; top: 0; left: 0; right: 0; z-index: 990; background-color: var(--sidebar-bg); color: var(--sidebar-text); padding: 8px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow); transition: background-color .3s ease, box-shadow .3s ease } @media (max-width:768px) { #topControlsBar { padding: 6px 10px } } #topControlsBar.item-added-glow { box-shadow: 0 0 20px 8px rgba(76, 175, 80, .6); background-color: #4caf50 } #topControlsBar.item-removed-flash { box-shadow: 0 0 20px 8px rgba(244, 67, 54, .6); background-color: #c62828 } .mini-order-summary { background-color: transparent; color: var(--sidebar-text); padding: 0; z-index: auto; box-shadow: none; display: flex; align-items: center; font-size: 1rem; font-weight: 600; transition: none; cursor: pointer } .mini-order-summary i { margin-left: 10px; font-size: 1.2rem; color: var(--sidebar-text) } @media (max-width:768px) { .mini-order-summary i { font-size: 1rem } } .mini-order-summary span { margin: 0 10px } .mini-order-summary.empty-state { flex-grow: 1; justify-content: center; text-align: center } .mini-order-summary.empty-state span { text-align: center; margin: 0 } .slideshow-container { max-width: 1200px; margin: 20px auto; position: relative; overflow: hidden; border-radius: 8px; box-shadow: var(--shadow); height: 250px; cursor: pointer; user-select: none } @media (max-width:768px) { .slideshow-container { height: 180px } } .mySlides { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity .6s ease-in-out } .mySlides.active-slide { opacity: 1 } .next, .prev { display: none } .dots-container { position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; z-index: 6 } .dot { cursor: pointer; height: 10px; width: 10px; margin: 0 2px; background-color: #bbb; border-radius: 50%; display: inline-block; transition: background-color .6s ease } .active-dot, .dot:hover { background-color: #717171 } .horizontal-categories { position: fixed; bottom: 0; left: 0; right: 0; display: flex; align-items: center; gap: 10px; padding: 8px 20px; background-color: var(--surface-color); box-shadow: var(--shadow); z-index: 950; transition: opacity .3s ease-in-out, transform .3s ease-in-out, visibility .3s ease-in-out } .horizontal-categories::-webkit-scrollbar { display: none } .horizontal-categories { scrollbar-width: none } @media (max-width:768px) { .horizontal-categories { padding: 6px 10px; gap: 8px } } .categories-scroll-wrapper { flex-grow: 1; overflow-x: auto; white-space: nowrap; display: flex; gap: 10px; padding-top: 5px; padding-bottom: 5px } .categories-scroll-wrapper::-webkit-scrollbar { display: none } .categories-scroll-wrapper { scrollbar-width: none } .search-icon-button { background-color: transparent; color: var(--text-color); border: none; padding: 8px; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: background-color var(--transition-speed) ease } .search-icon-button:hover { background-color: var(--border-color) } @media (max-width:768px) { .search-icon-button { padding: 6px; font-size: 1rem } } .horizontal-categories .category-button { flex-shrink: 0; background-color: var(--background-color); color: var(--text-color); border: 1px solid var(--border-color); padding: 8px 15px; font-size: .9rem; cursor: pointer; border-radius: 20px; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, border-color var(--transition-speed) ease } .horizontal-categories .category-button i { margin-left: 8px } .horizontal-categories .category-button:hover { background-color: var(--border-color) } .horizontal-categories .category-button.active { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); font-weight: 600; position: relative; box-shadow: 0 2px 8px rgba(0, 0, 0, .15) } .horizontal-categories.hidden-bar { opacity: 0; visibility: hidden; transform: translateY(100%) } .menu-toggle-button { background-color: transparent; color: #fff; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 1.2rem; font-weight: 600; transition: background-color var(--transition-speed) ease; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; box-sizing: border-box; box-shadow: none } .menu-toggle-button i { margin: 0; font-size: 1.5rem } .menu-toggle-button:hover { background-color: rgba(255, 255, 255, .1) } .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; position: relative } .main-wrapper { display: flex; gap: 30px } @media (max-width:768px) { .container { padding: 0 10px } .main-wrapper { flex-direction: column; gap: 20px } } .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 98; background-color: rgba(0, 0, 0, .6); transition: opacity var(--transition-speed) ease; opacity: 0 } .sidebar-overlay.visible { display: block; opacity: 1 } .sidebar { position: fixed; top: 0; right: -280px; width: 280px; height: 100%; background-color: var(--sidebar-bg); color: var(--sidebar-text); z-index: 99; box-shadow: var(--shadow); transition: right var(--transition-speed) ease; padding: 25px 15px; box-sizing: border-box; overflow-y: auto; display: flex; flex-direction: column } .sidebar.open { right: 0 } @media (max-width:768px) { .sidebar { width: 250px; right: -250px } .sidebar.open { right: 0 } } .sidebar .sidebar-search { position: relative; margin-bottom: 15px } .sidebar .sidebar-search input[type=text] { margin-bottom: 0; padding: 10px; border: 1px solid rgba(255, 255, 255, .2); border-radius: 4px; background-color: rgba(255, 255, 255, .1); color: var(--sidebar-text); font-size: .9rem; width: calc(100% - 40px); box-sizing: border-box; padding-right: 35px } .sidebar .sidebar-search input[type=text]::placeholder { color: rgba(255, 255, 255, .5) } @media (max-width:768px) { .sidebar .sidebar-search input[type=text] { width: calc(100% - 34px); padding: 8px; font-size: .8rem; padding-right: 30px } } .sidebar .sidebar-search .search-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: rgba(255, 255, 255, .5); font-size: 1.1rem; pointer-events: none } @media (max-width:768px) { .sidebar .sidebar-search .search-icon { right: 8px; font-size: 1rem } } .sidebar .sidebar-search .voice-search-button { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: 0 0; border: none; color: rgba(255, 255, 255, .5); cursor: pointer; font-size: 1.1rem; padding: 5px; border-radius: 4px; transition: color .3s ease } .sidebar .sidebar-search .voice-search-button:hover { color: rgba(255, 255, 255, .8) } .sidebar .sidebar-search .voice-search-button.active { color: var(--accent-color) } .close-sidebar-button { background: 0 0; border: none; font-size: 1.8rem; color: var(--sidebar-text); cursor: pointer; align-self: flex-start; margin-left: 5px; margin-bottom: 25px; transition: color var(--transition-speed) ease } .close-sidebar-button:hover { color: var(--danger-color) } .sidebar .category-title { font-size: 1.2rem; font-weight: 700; color: var(--subtle-text-color); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, .1); padding-right: 10px } .sidebar .category-list { display: flex; flex-direction: column; gap: 5px } .sidebar .category-list button { background-color: transparent; color: var(--sidebar-text); border: none; padding: 14px 15px; font-size: 1rem; cursor: pointer; text-align: right; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; width: 100%; border-radius: 4px; display: flex; align-items: center; justify-content: flex-start } .sidebar .category-list button i { margin-left: 10px } .sidebar .category-list button:hover { background-color: rgba(255, 255, 255, .08); color: #fff } .sidebar .category-list button.active { background-color: var(--primary-color); color: #fff; font-weight: 700; position: relative; box-shadow: 0 2px 8px rgba(0, 0, 0, .15) } .content-area { flex-grow: 1; padding-top: 0 } .controls-above-products { background-color: var(--surface-color); padding: 20px; margin-bottom: 30px; border-radius: 8px; box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 20px; margin-top: 20px } @media (max-width:768px) { .controls-above-products { padding: 15px; gap: 10px } } .search-bar { display: flex; align-items: center; position: relative } .search-bar input { flex-grow: 1; padding: 12px 15px; padding-right: 40px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; margin-left: 10px; box-sizing: border-box; transition: border-color var(--transition-speed) ease } .search-bar input:focus { outline: 0; border-color: var(--primary-color); box-shadow: 0 0 0 .2rem rgba(170, 85, 85, .25) } @media (max-width:768px) { .search-bar input { font-size: .9rem; padding: 10px 12px; padding-right: 35px } } .search-bar .search-icon { position: absolute; right: 20px; color: var(--subtle-text-color); font-size: 1.1rem; pointer-events: none } @media (max-width:768px) { .search-bar .search-icon { right: 15px } } .search-bar .voice-search-button { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: 0 0; border: none; color: var(--subtle-text-color); cursor: pointer; font-size: 1.1rem; padding: 5px; border-radius: 4px; transition: color .3s ease } .search-bar .voice-search-button:hover { color: var(--text-color) } .search-bar .voice-search-button.active { color: var(--accent-color) } .sort-controls { display: flex; align-items: center; gap: 15px; font-size: 1rem } .sort-controls label { font-weight: 600; color: var(--text-color) } .sort-controls select { padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; cursor: pointer; background-color: var(--background-color); transition: border-color var(--transition-speed) ease; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20256%20448%22%20enable-background%3D%22new%200%200%20256%20448%22%3E%3Cpath%20fill%3D%22%23212529%22%20d%3D%22M255.9%20168c0-4.2-1.7-8.3-4.7-11.3l-114.2-114.2c-6.2-6.2-16.4-6.2-22.6%200L5.5%20156.7c-6.2%206.2-6.2%2016.4%200%2022.6%206.2%206.2%2016.4%206.2%2022.6%200l91.4-91.4%2091.4%2091.4c6.2%206.2-16.4%206.2-22.6%200C254.2%20176.3%20255.9%20172.2%20255.9%20168z%22%2F%3E%3Cpath%20fill%3D%22%23212529%22%20d%3D%22M255.9%20280c0%204.2-1.7%208.3-4.7%2011.3l-114.2%20114.2c-6.2%206.2-16.4%206.2-22.6%200L5.5%20291.3c-6.2-6.2-6.2-16.4%200-22.6%206.2-6.2%2016.4-6.2%2022.6%200l91.4%2091.4%2091.4-91.4c6.2-6.2%2016.4%206.2%2022.6%200C254.2%20271.7%20255.9%20275.8%20255.9%20280z%22%2F%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: calc(100% - 10px) center; background-size: 10px 10px; padding-left: 30px; border-color: var(--subtle-text-color) } .sort-controls select:focus { outline: 0; border-color: var(--primary-color); box-shadow: 0 0 0 .2rem rgba(170, 85, 85, .25) } .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; margin-bottom: 40px } @media (max-width:768px) { .products-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px } } .product-item { background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0, 0, 0, .08); display: flex; flex-direction: column; justify-content: space-between; transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease, opacity var(--transition-speed) ease; position: relative } @media (max-width:768px) { .product-item { padding: 15px } } .product-item:hover { transform: translateY(-5px); box-shadow: var(--shadow) } .product-item.hidden { display: none } .product-item img { max-width: 100%; height: 180px; object-fit: cover; border-radius: 4px; margin: 0 auto 15px auto; cursor: pointer } @media (max-width:768px) { .product-item img { height: 120px; margin-bottom: 10px } } .product-name { font-weight: 700; margin-bottom: 8px; flex-grow: 1; color: var(--text-color); font-size: 1.1rem; cursor: pointer } @media (max-width:768px) { .product-name { font-size: 1rem; margin-bottom: 5px } } .product-description { font-size: .9rem; color: var(--subtle-text-color); margin-bottom: 15px; flex-grow: 1; text-align: center; cursor: pointer } .product-item[data-product-name="منتج فاخر"] .product-description { display: block } @media (max-width:768px) { .product-description { font-size: .85rem; margin-bottom: 10px } } .product-price { color: var(--danger-color); font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; cursor: pointer; display: flex; /* Changed to flex for vertical stacking */ flex-direction: column; /* Stack items vertically */ justify-content: center; align-items: center; /* Center items horizontally */ gap: 5px; /* Space between current and original price */ } @media (max-width:768px) { .product-price { font-size: 1rem; margin-bottom: 10px } } .product-price .original-price { text-decoration: line-through; color: #777; display: block; /* Changed to block for stacking */ font-size: .9em; margin-bottom: 0; order: 1; /* Place original price first (above) */ } .product-price span:not(.original-price) { order: 2; /* Place current price second (below) */ } .discount-badge { position: absolute; top: 10px; right: 10px; background-color: var(--danger-color); color: #fff; font-size: .8rem; font-weight: 700; padding: 3px 8px; border-radius: 4px; z-index: 1; white-space: nowrap; /* Prevent text wrapping */ } .share-button { position: absolute; top: 10px; left: 10px; background-color: rgba(255, 255, 255, .85); color: var(--subtle-text-color); border: none; border-radius: 4px; width: 32px; height: 32px; font-size: 1.1rem; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; padding: 0; z-index: 5; box-shadow: 0 1px 4px rgba(0, 0, 0, .1) } .share-button:hover { background-color: var(--button-grey); color: var(--text-color) } .product-item .share-button { display: flex !important } .quantity-control { display: none; justify-content: center; align-items: center; margin-top: 10px; margin-bottom: 15px } .product-item.in-cart .quantity-control { display: flex } @media (max-width:768px) { .quantity-control { margin-bottom: 10px; margin-top: 8px } } .quantity-control button { width: 35px; height: 35px; padding: 0; margin: 0 4px; font-size: 1.3rem; line-height: 1; border: none; border-radius: 4px; cursor: pointer; transition: background-color var(--transition-speed) ease; display: flex; justify-content: center; align-items: center; font-family: Arial, sans-serif; box-sizing: border-box } .quantity-control .increase-quantity { background-color: var(--accent-color); color: #fff } .quantity-control .increase-quantity:hover { background-color: var(--accent-color-dark) } .quantity-control .decrease-quantity { background-color: var(--danger-color); color: #fff } .quantity-control .decrease-quantity:hover { background-color: #c62828 } .summary-item .quantity-control .increase-quantity { background-color: var(--accent-color); color: #fff } .summary-item .quantity-control .increase-quantity:hover { background-color: var(--accent-color-dark) } .summary-item .quantity-control .decrease-quantity { background-color: var(--danger-color); color: #fff } .summary-item .quantity-control .decrease-quantity:hover { background-color: #c62828 } .quantity-input { width: 40px; text-align: center; border: 1px solid var(--border-color); border-radius: 4px; margin: 0 5px; padding: 6px 0; font-size: 1.1rem; -moz-appearance: textfield } .quantity-input::-webkit-inner-spin-button, .quantity-input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0 } .add-to-cart-button { background-color: var(--accent-color); color: #fff; border: none; padding: 10px 20px; font-size: 1rem; font-weight: 600; border-radius: 4px; cursor: pointer; transition: background-color var(--transition-speed) ease; display: flex; align-items: center; justify-content: center; gap: 8px } .add-to-cart-button i { font-size: 1.1em } .add-to-cart-button:hover { background-color: var(--accent-color-dark) } .product-item.in-cart .add-to-cart-button { display: none } /* Modal specific quantity control and add to cart button visibility */ .image-modal-content .quantity-control { display: none; /* Hidden by default in modal */ margin-top: 0; margin-bottom: 10px; opacity: 1; max-height: none; } .image-modal-content .add-to-cart-button { display: flex; /* Shown by default in modal */ } /* New: Done button in modal */ .image-modal-content .done-button { background-color: var(--accent-color); color: #fff; border: none; padding: 10px 20px; font-size: 1rem; font-weight: 600; border-radius: 4px; cursor: pointer; transition: background-color var(--transition-speed) ease; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; /* Space from quantity controls */ width: 100%; } .image-modal-content .done-button:hover { background-color: var(--accent-color-dark); } @keyframes flash-green { 0% { background-color: initial } 50% { background-color: var(--light-green) } 100% { background-color: initial } } @keyframes flash-red { 0% { background-color: initial } 50% { background-color: var(--danger-color); color: #fff } 100% { background-color: initial; color: initial } } @keyframes flash-skyblue { 0% { background-color: initial } 50% { background-color: var(--sky-blue) } 100% { background-color: initial } } @keyframes flash-pink { 0% { background-color: initial } 50% { background-color: var(--pink); color: var(--text-color) } 100% { background-color: initial; color: initial } } .flash-green { animation: flash-green .5s ease-in-out } .flash-red { animation: flash-red .5s ease-in-out } .flash-skyblue { animation: flash-skyblue .5s ease-in-out } .flash-pink { animation: flash-pink .5s ease-in-out } .order-summary { margin-bottom: 30px; background-color: var(--surface-color); border-radius: 8px; box-shadow: var(--shadow) } .summary-toggle-button { width: 100%; padding: 15px 20px; background-color: var(--primary-color); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 1.2rem; text-align: right; margin-bottom: 0; display: flex; justify-content: space-between; align-items: center; font-weight: 700; transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease } .summary-toggle-button i { margin-right: 10px; transition: transform .3s ease; transform: rotate(180deg) } .summary-toggle-button.collapsed i { transform: rotate(0) } .summary-toggle-button:hover { background-color: #844 } .summary-toggle-button span { display: block } .summary-toggle-button span:last-child { display: none } #collapsibleSummaryContent { display: none; overflow: visible; transition: none; padding: 20px; border: 1px solid var(--border-color); border-top: none; background-color: var(--surface-color); box-sizing: border-box; border-radius: 0 0 8px 8px } @media (max-width:768px) { #collapsibleSummaryContent { padding: 15px; border-radius: 0 0 8px 8px } } .order-summary.open #collapsibleSummaryContent { display: block } .order-summary h2 { margin-top: 0; color: var(--text-color); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color) } .selected-items-list { margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px } .summary-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); justify-content: space-between; position: relative } .summary-item:last-child { border-bottom: none; padding-bottom: 0; margin-bottom: 0 } .summary-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-left: 15px; border: 1px solid var(--border-color) } @media (max-width:768px) { .summary-item img { width: 40px; height: 40px; margin-left: 10px } } .summary-item-details { flex-grow: 1; margin-right: 15px } @media (max-width:768px) { .summary-item-details { margin-right: 10px } } .summary-item-details span { display: block; margin-bottom: 4px } .summary-item .item-name { font-weight: 700; color: var(--text-color); font-family: Cairo, sans-serif } @media (max-width:768px) { .summary-item .item-name { font-size: 1em } } .summary-item .item-quantity { font-weight: 400; color: var(--subtle-text-color); font-size: .95em } .summary-item .item-unit-price { font-weight: 400; color: var(--subtle-text-color); font-size: .95em } .summary-item .item-subtotal { font-weight: 700; color: var(--accent-color); font-size: 1.1em; margin-top: 5px } @media (max-width:768px) { .summary-item .item-subtotal { font-size: 1em } } .summary-item .quantity-control { display: flex; opacity: 1; max-height: none; margin: 0 10px } .summary-item .quantity-control button { width: 35px; height: 35px; padding: 0; margin: 0 4px; font-size: 1.3rem; line-height: 1; border: none; border-radius: 4px; cursor: pointer; transition: background-color var(--transition-speed) ease; animation: none; display: flex; justify-content: center; align-items: center; font-family: Arial, sans-serif; box-sizing: border-box } @media (max-width:768px) { .summary-item .quantity-control button { width: 30px; height: 30px; font-size: 1.2rem; margin: 0 3px } } .quantity-input { width: 40px; text-align: center; border: 1px solid var(--border-color); border-radius: 4px; margin: 0 5px; padding: 6px 0; font-size: 1.1rem; -moz-appearance: textfield } .quantity-input::-webkit-inner-spin-button, .quantity-input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0 } .delivery-fee, .free-delivery-message-summary { font-size: 1.2rem; font-weight: 600; color: var(--subtle-text-color); text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border-color) } .free-delivery-message-summary { color: var(--accent-color) } .total-price { font-size: 1.6rem; font-weight: 700; text-align: center; color: var(--accent-color); margin-top: 15px; padding-top: 20px; border-top: 1px solid var(--border-color) } @media (max-width:768px) { .delivery-fee, .free-delivery-message-summary { font-size: 1rem; margin-top: 5px; padding-top: 5px } .total-price { font-size: 1.3rem; margin-top: 10px; padding-top: 15px } } form { display: flex; flex-direction: column; max-width: 600px; margin: 30px auto; padding: 35px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--surface-color); box-shadow: var(--shadow) } @media (max-width:768px) { form { padding: 20px; margin: 20px auto } form label { font-size: 1rem; margin-bottom: 5px } } form input[type=email], form input[type=text] { margin-bottom: 25px; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; width: calc(100% - 30px); box-sizing: border-box; transition: border-color var(--transition-speed) ease } @media (max-width:768px) { form input[type=email], form input[type=text] { padding: 10px 12px; margin-bottom: 15px; width: calc(100% - 24px) } } form input[type=email]:focus, form input[type=text]:focus { outline: 0; border-color: var(--primary-color); box-shadow: 0 0 0 .2rem rgba(170, 85, 85, .25) } form textarea#message { display: none } form label[for=message] { display: none } button[type=submit] { padding: 14px 25px; background-color: var(--accent-color); color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 1.2rem; transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; margin-top: 10px; font-weight: 600 } button[type=submit]:hover { background-color: var(--accent-color-dark); box-shadow: var(--shadow) } /* تثبيت الطلب button styling */ #openOrderModalButton { padding: 15px 30px; background: linear-gradient(45deg, var(--accent-color), var(--accent-color-dark)); /* Changed to green */ color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 1.3rem; font-weight: 700; transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1); margin-top: 20px; width: 100%; } #openOrderModalButton:hover { background: linear-gradient(45deg, var(--accent-color-dark), var(--accent-color)); /* Changed to green */ transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); } @media (max-width:768px) { button[type=submit] { padding: 10px 15px; font-size: 1.1rem } } #response { margin-top: 30px; text-align: center; font-weight: 600; padding: 15px; border-radius: 4px; min-height: 1.5em; transition: all var(--transition-speed) ease; display: flex; flex-direction: column; align-items: center } #response>:not(:last-child) { margin-bottom: 10px } .whatsapp-button { background-color: #25d366; color: #fff; border: none; padding: 12px 25px; font-size: 1.1rem; font-weight: 600; border-radius: 4px; cursor: pointer; transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 15px } .whatsapp-button i { font-size: 1.2em } .whatsapp-button:hover { background-color: #1eac51; box-shadow: var(--shadow) } .success { color: #1b5e20; background-color: #e8f5e9; border: 1px solid #a5d6a7 } .error { color: #b71c1c; background-color: #ffebee; border: 1px solid #ef9a9a } .confirm-delete-modal-overlay, .free-delivery-alert-overlay, .image-modal-overlay, .sort-modal-overlay, .order-details-modal-overlay, .governorate-select-modal-overlay, .phone-confirm-modal-overlay { /* Added new modal overlay */ position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, .7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity .3s ease, visibility .3s ease } .confirm-delete-modal-overlay.visible, .free-delivery-alert-overlay.visible, .image-modal-overlay.visible, .sort-modal-overlay.visible, .order-details-modal-overlay.visible, .governorate-select-modal-overlay.visible, .phone-confirm-modal-overlay.visible { /* Added new modal overlay */ opacity: 1; visibility: visible } .confirm-delete-modal-content, .free-delivery-alert-box, .image-modal-content, .sort-modal-content, .order-details-modal-content, .governorate-select-modal-content, .phone-confirm-modal-content { /* Added new modal content */ background-color: var(--surface-color); padding: 30px; border-radius: 8px; box-shadow: var(--shadow); text-align: center; max-width: 400px; width: 90%; position: relative; transform: scale(.9); transition: transform .3s ease; overflow-y: auto; /* Allow scrolling for modal content */ max-height: 90vh; /* Limit height for modal content */ } .confirm-delete-modal-overlay.visible .confirm-delete-modal-content, .free-delivery-alert-overlay.visible .free-delivery-alert-box, .image-modal-overlay.visible .image-modal-content, .sort-modal-overlay.visible .sort-modal-content, .order-details-modal-overlay.visible .order-details-modal-content, .governorate-select-modal-overlay.visible .governorate-select-modal-content, .phone-confirm-modal-overlay.visible .phone-confirm-modal-content { /* Added new modal content */ transform: scale(1) } .image-modal-content { max-width: 90%; max-height: 90%; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; overflow-y: hidden; /* Changed to hidden for custom scroll */ position: relative; } .sort-modal-content { padding: 20px; text-align: right } .sort-modal-content h3 { margin-top: 0; margin-bottom: 15px; color: var(--text-color); font-size: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; text-align: center } .sort-options { display: flex; flex-direction: column; gap: 10px } .sort-options button { background-color: var(--background-color); color: var(--text-color); border: 1px solid var(--border-color); padding: 10px 15px; font-size: 1rem; cursor: pointer; border-radius: 4px; transition: background-color var(--transition-speed) ease; text-align: right } .sort-options button:hover { background-color: var(--border-color) } .sort-options button.active { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); font-weight: 600 } .confirm-delete-modal-content .modal-close-button, .free-delivery-alert-box .close-button, .image-modal-content .modal-close-button, .sort-modal-content .modal-close-button, .order-details-modal-content .modal-close-button, .governorate-select-modal-content .modal-close-button, .phone-confirm-modal-content .modal-close-button { /* Added new modal close button */ position: absolute; top: 10px; left: 10px; font-size: 1.5rem; font-weight: 700; color: var(--subtle-text-color); border: none; background: 0 0; cursor: pointer } .confirm-delete-modal-content .modal-close-button:hover, .free-delivery-alert-box .close-button:hover, .image-modal-content .modal-close-button:hover, .sort-modal-content .modal-close-button:hover, .order-details-modal-content .modal-close-button:hover, .governorate-select-modal-content .modal-close-button:hover, .phone-confirm-modal-content .modal-close-button:hover { /* Added new modal close button */ color: var(--text-color) } /* Removed share button from modal */ /* .image-modal-content .share-button { position: absolute; top: 10px; left: 40px; background-color: rgba(255, 255, 255, .85); color: var(--subtle-text-color); border: none; border-radius: 4px; width: 32px; height: 32px; font-size: 1.1rem; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; padding: 0; z-index: 10; box-shadow: 0 1px 4px rgba(0, 0, 0, .1) } .image-modal-content .share-button:hover { background-color: var(--button-grey); color: var(--text-color) } @media (max-width:768px) { .image-modal-content .share-button { width: 25px; height: 25px; font-size: .9rem; top: 8px; left: 35px } } */ .image-modal-content img { display: block; max-width: 100%; max-height: 40vh; object-fit: contain; margin: 0 auto; border-radius: 4px; border: 1px solid var(--border-color) } .image-modal-details { text-align: center; color: var(--text-color); width: 100%; margin-bottom: 10px } .image-modal-details h3 { margin: 0 0 5px 0; font-size: 1.4rem; color: var(--primary-color) } .image-modal-details p { margin: 0 0 5px 0; font-size: 1rem; color: var(--subtle-text-color) } .image-modal-details .modal-price { font-size: 1.2rem; font-weight: 700; color: var(--danger-color); display: flex; /* Changed to flex for inline display */ justify-content: center; align-items: baseline; /* Align text baselines */ gap: 8px; /* Space between current and original price */ } .image-modal-details .modal-price .original-price { text-decoration: line-through; color: #777; display: inline-block; /* Kept as inline-block for side-by-side */ font-size: .9em; margin-bottom: 0; order: 2; /* Place original price second (to the right in RTL) */ } .image-modal-details .modal-price span:not(.original-price) { order: 1; /* Place current price first (to the left in RTL) */ } .image-modal-details .modal-price .discount-badge { position: static; display: inline-block; margin-left: 10px; margin-right: 0; white-space: nowrap; /* Prevent text wrapping */ } .image-modal-content .modal-description { font-size: .9rem; color: var(--subtle-text-color); margin: 0 0 10px 0; text-align: center } .free-delivery-alert-box i.fa-gift { font-size: 3rem; color: var(--accent-color); margin-bottom: 15px } .free-delivery-alert-box h3 { color: var(--text-color); margin-top: 0; font-size: 1.8rem; margin-bottom: 10px } .free-delivery-alert-box p { color: var(--accent-color); font-size: 1.3rem; font-weight: 700; margin-bottom: 0 } .summary-item.item-suspended .item-name { text-decoration: line-through; color: #777 } .summary-item.item-suspended .quantity-control, .summary-item.item-suspended img { filter: grayscale(100%); opacity: .6 } .summary-item.item-suspended .summary-item-details .item-quantity, .summary-item.item-suspended .summary-item-details .item-subtotal, .summary-item.item-suspended .summary-item-details .item-unit-price { color: #999 !important } .summary-item .item-actions { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; margin-right: 5px; margin-left: 0; min-width: 40px } .summary-item .item-actions button { background-color: var(--button-grey); color: var(--text-color); border: none; border-radius: 4px; width: 35px; height: 35px; font-size: 1.1rem; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color var(--transition-speed) ease; padding: 0 } .summary-item .item-actions button:hover { background-color: var(--button-grey-hover) } .summary-item .item-actions .suspend-item-button { background-color: var(--danger-color); color: #fff } .summary-item .item-actions .suspend-item-button:hover { background-color: #c62828 } .summary-item .item-actions .undo-suspend-button { background-color: var(--accent-color); color: #fff } .summary-item .item-actions .undo-suspend-button:hover { background-color: var(--accent-color-dark) } .summary-item .item-actions .confirm-final-delete-button { background-color: var(--danger-color); color: #fff } .summary-item .item-actions .confirm-final-delete-button:hover { background-color: #e53935 } .confirm-delete-modal-content h3 { font-family: Cairo, sans-serif; color: var(--primary-color); margin-top: 0; font-size: 1.7rem; margin-bottom: 25px; font-weight: 700 } .confirm-delete-modal-content .modal-buttons { display: flex; justify-content: space-around; margin-top: 30px } .confirm-delete-modal-content .modal-buttons button { padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1.1rem; font-weight: 600; min-width: 120px; transition: all .3s ease; box-shadow: 0 2px 5px rgba(0, 0, 0, .1) } .confirm-delete-modal-content .modal-buttons button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0, 0, 0, .15) } .confirm-delete-modal-content .modal-confirm-yes { background-color: var(--danger-color); color: #fff; border: none } .confirm-delete-modal-content .modal-confirm-yes:hover { background-color: #d32f2f } .confirm-delete-modal-content .modal-confirm-no { background-color: var(--button-grey); color: var(--text-color); border: 1px solid var(--border-color) } .confirm-delete-modal-no:hover { background-color: var(--button-grey-hover); border-color: #aaa } .summary-item .item-actions button i { margin: 0 } @media (max-width:768px) { .summary-item .item-actions button { width: 30px; height: 30px; font-size: 1rem } .confirm-delete-modal-content { padding: 25px } .confirm-delete-modal-content h3 { font-size: 1.4rem } .confirm-delete-modal-content .modal-buttons button { padding: 10px 20px; font-size: 1rem; min-width: 100px } } .sort-button { background-color: var(--background-color); color: var(--text-color); border: 1px solid var(--border-color); padding: 10px 15px; font-size: 1rem; cursor: pointer; border-radius: 4px; transition: background-color var(--transition-speed) ease; display: flex; align-items: center; gap: 8px } .sort-button:hover { background-color: var(--border-color) } .product-item img.error-image { filter: grayscale(100%); opacity: .3; border: 1px dashed var(--subtle-text-color) } footer { text-align: center; margin-top: 40px; padding: 20px; color: var(--subtle-text-color); font-size: .9rem; border-top: 1px solid var(--border-color) } footer p { margin: 5px 0 } /* Styles for the new multi-step order details modal */ .order-details-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, .7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity .3s ease, visibility .3s ease; } .order-details-modal-overlay.visible { opacity: 1; visibility: visible; } .order-details-modal-content { background-color: var(--surface-color); padding: 30px; border-radius: 8px; box-shadow: var(--shadow); text-align: right; max-width: 400px; width: 90%; position: relative; transform: scale(.9); transition: transform .3s ease; overflow-y: auto; max-height: 90vh; } .order-details-modal-overlay.visible .order-details-modal-content { transform: scale(1); } .order-details-modal-content h3 { margin-top: 0; margin-bottom: 15px; color: var(--primary-color); font-size: 1.8rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; text-align: center; } .order-details-modal-content .modal-step { display: none; /* Hidden by default, shown by JS */ flex-direction: column; gap: 15px; width: 100%; } .order-details-modal-content .modal-step.active { display: flex; } .order-details-modal-content label { font-weight: 600; color: var(--text-color); margin-bottom: 5px; display: block; } .order-details-modal-content input[type="text"], .order-details-modal-content input[type="tel"], .order-details-modal-content select, .order-details-modal-content textarea { width: calc(100% - 24px); /* Account for padding */ padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; box-sizing: border-box; transition: border-color var(--transition-speed) ease; } .order-details-modal-content input:focus, .order-details-modal-content select:focus, .order-details-modal-content textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 .2rem rgba(170, 85, 85, .25); } .order-details-modal-content textarea { min-height: 80px; resize: vertical; } .order-details-modal-content .modal-navigation { display: flex; justify-content: space-between; margin-top: 20px; gap: 10px; } .order-details-modal-content .modal-navigation button { padding: 12px 25px; border-radius: 4px; cursor: pointer; font-size: 1.1rem; font-weight: 600; transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; flex-grow: 1; min-width: 100px; } .order-details-modal-content .modal-navigation .next-button, .order-details-modal-content .modal-navigation .submit-order-button { background-color: var(--accent-color); color: #fff; border: none; } .order-details-modal-content .modal-navigation .next-button:hover, .order-details-modal-content .modal-navigation .submit-order-button:hover { background-color: var(--accent-color-dark); box-shadow: var(--shadow); } .order-details-modal-content .modal-navigation .prev-button { background-color: var(--button-grey); color: var(--text-color); border: 1px solid var(--border-color); } .order-details-modal-content .modal-navigation .prev-button:hover { background-color: var(--button-grey-hover); } .order-details-modal-content .modal-error-message { color: var(--danger-color); font-size: 0.9rem; margin-top: -10px; margin-bottom: 10px; text-align: center; } /* New styles for governorate selection modal */ .governorate-select-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, .8); display: flex; justify-content: center; align-items: center; z-index: 1001; /* Higher than other modals */ opacity: 0; visibility: hidden; transition: opacity .3s ease, visibility .3s ease; } .governorate-select-modal-overlay.visible { opacity: 1; visibility: visible; } .governorate-select-modal-content { background-color: var(--surface-color); padding: 30px; border-radius: 8px; box-shadow: var(--shadow); text-align: center; max-width: 600px; width: 90%; position: relative; transform: scale(.9); transition: transform .3s ease; overflow-y: auto; max-height: 90vh; } .governorate-select-modal-overlay.visible .governorate-select-modal-content { transform: scale(1); } .governorate-select-modal-content h3 { margin-top: 0; margin-bottom: 20px; color: var(--primary-color); font-size: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; } .governorate-list-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; } .governorate-list-grid button { background-color: var(--background-color); color: var(--text-color); border: 1px solid var(--border-color); padding: 15px 10px; font-size: 1.1rem; font-weight: 600; border-radius: 8px; cursor: pointer; transition: background-color .3s ease, transform .2s ease, box-shadow .2s ease; display: flex; justify-content: center; align-items: center; text-align: center; } .governorate-list-grid button:hover { background-color: var(--border-color); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, .1); } .governorate-list-grid button.selected { background-color: var(--accent-color); color: #fff; border-color: var(--accent-color); box-shadow: 0 4px 8px rgba(76, 175, 80, .3); } .governorate-list-grid button.selected:hover { background-color: var(--accent-color-dark); } /* Styles for modal image navigation arrows */ .image-modal-content .modal-nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); width: 45px; /* Increased size */ height: 45px; /* Increased size */ background-color: rgba(0, 0, 0, 0.6); /* Darker background */ color: white; border: none; cursor: pointer; font-size: 1.8rem; /* Larger icon */ z-index: 10; border-radius: 50%; display: flex; justify-content: center; align-items: center; transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); /* Subtle shadow */ } .image-modal-content .modal-nav-arrow:hover { background-color: rgba(0, 0, 0, 0.8); /* Even darker on hover */ transform: translateY(-50%) scale(1.05); /* Slight scale up */ box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); } .image-modal-content .modal-nav-prev { right: 15px; /* More padding from edge */ } .image-modal-content .modal-nav-next { left: 15px; /* More padding from edge */ } /* Styling for the dynamic cart summary bar */ #dynamicCartSummaryBar { position: fixed; top: 50px; /* Position right below the top controls bar */ left: 0; right: 0; z-index: 980; /* Below topControlsBar, above other content */ background-color: var(--surface-color); box-shadow: var(--shadow); transform: translateY(-100%); /* Initially hidden above the screen */ transition: transform 0.3s ease-out; padding: 10px 20px; display: flex; flex-direction: row; /* Changed to row for single line */ justify-content: center; /* Center content */ align-items: center; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; opacity: 0; /* Also use opacity for fade effect */ visibility: hidden; /* Ensure it's not clickable when hidden */ max-height: auto; /* No max height needed for single line */ overflow: hidden; /* Hide overflow */ } #dynamicCartSummaryBar.visible { transform: translateY(0); /* Slide down */ opacity: 1; visibility: visible; } #dynamicCartSummaryBar .summary-header { display: flex; justify-content: center; /* Center content */ align-items: center; width: 100%; /* No margin-bottom needed as it's a single line */ } #dynamicCartSummaryBar .summary-text { display: none; /* Hidden as per user request */ } #dynamicCartSummaryBar .confirm-order-button { background-color: var(--accent-color); color: #fff; border: none; padding: 8px 15px; font-size: 1rem; font-weight: 600; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; white-space: nowrap; } #dynamicCartSummaryBar .confirm-order-button:hover { background-color: var(--accent-color-dark); } /* Removed styles for toggle button and product list container */ /* #dynamicCartSummaryBar .toggle-list-button { ... } */ /* #dynamicCartSummaryBar .product-list-container { ... } */ /* #dynamicCartSummaryBar.expanded .product-list-container { ... } */ /* #dynamicCartSummaryBar .dynamic-summary-item { ... } */ @media (max-width: 768px) { #dynamicCartSummaryBar { padding: 8px 10px; flex-direction: column; /* Stack vertically on small screens */ gap: 10px; text-align: center; } #dynamicCartSummaryBar .summary-header { flex-direction: column; /* Stack vertically on small screens */ gap: 5px; margin-bottom: 5px; } #dynamicCartSummaryBar .summary-text { font-size: 1rem; gap: 10px; justify-content: center; width: 100%; } #dynamicCartSummaryBar .confirm-order-button { width: 100%; padding: 10px; font-size: 0.9rem; } /* Removed styles for toggle button and product list container */ /* #dynamicCartSummaryBar .toggle-list-button { ... } */ /* #dynamicCartSummaryBar .product-list-container { ... } */ /* #dynamicCartSummaryBar .dynamic-summary-item img { ... } */ /* #dynamicCartSummaryBar .dynamic-item-details { ... } */ /* #dynamicCartSummaryBar .dynamic-item-details .item-subtotal { ... } */ } /* Styling for clickable governorate display */ #governorateDisplay { padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; text-align: center; color: var(--subtle-text-color); cursor: pointer; /* Indicate it's clickable */ transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; } #governorateDisplay:hover { border-color: var(--primary-color); box-shadow: 0 0 0 .2rem rgba(170, 85, 85, .1); } #governorateDisplay.selected { color: var(--text-color); font-weight: 600; } /* Styles for OTP input and buttons */ .phone-input-group { display: flex; flex-direction: column; /* Stack vertically on small screens */ gap: 10px; } .phone-input-group input { flex-grow: 1; margin-bottom: 0 !important; /* Override default form margin */ } .otp-buttons-container { display: flex; gap: 10px; flex-wrap: wrap; /* Allow buttons to wrap on small screens */ } .otp-buttons-container button { padding: 10px 15px; background-color: var(--primary-color); color: #fff; border: none; border-radius: 4个体; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: background-color 0.3s ease; white-space: nowrap; flex-grow: 1; /* Allow buttons to grow and fill space */ } .otp-buttons-container button:hover { background-color: #844; } .otp-buttons-container button:disabled { background-color: var(--button-grey); color: var(--subtle-text-color); cursor: not-allowed; } @media (min-width: 768px) { .phone-input-group { flex-direction: row; /* Horizontal layout on larger screens */ align-items: center; } .otp-buttons-container { flex-wrap: nowrap; /* No wrapping on larger screens */ } } /* Phone Confirmation Modal Styles */ .phone-confirm-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, .7); display: flex; justify-content: center; align-items: center; z-index: 1002; /* Higher than other modals */ opacity: 0; visibility: hidden; transition: opacity .3s ease, visibility .3s ease; } .phone-confirm-modal-overlay.visible { opacity: 1; visibility: visible; } .phone-confirm-modal-content { background-color: var(--surface-color); padding: 30px; border-radius: 8px; box-shadow: var(--shadow); text-align: center; max-width: 400px; width: 90%; position: relative; transform: scale(.9); transition: transform .3s ease; } .phone-confirm-modal-overlay.visible .phone-confirm-modal-content { transform: scale(1); } .phone-confirm-modal-content h3 { margin-top: 0; margin-bottom: 20px; color: var(--primary-color); font-size: 1.8rem; } .phone-confirm-modal-content p { font-size: 1.2rem; color: var(--text-color); margin-bottom: 20px; } .phone-confirm-modal-content .confirmed-phone-number { font-size: 1.5rem; font-weight: 700; color: var(--accent-color); display: block; margin-bottom: 25px; } .phone-confirm-modal-content .modal-buttons { display: flex; justify-content: space-around; gap: 15px; } .phone-confirm-modal-content .modal-buttons button { padding: 12px 25px; border-radius: 4px; cursor: pointer; font-size: 1.1rem; font-weight: 600; transition: background-color .3s ease, box-shadow .3s ease; flex-grow: 1; } .phone-confirm-modal-content .modal-buttons .confirm-yes { background-color: var(--accent-color); color: #fff; border: none; } .phone-confirm-modal-content .modal-buttons .confirm-yes:hover { background-color: var(--accent-color-dark); box-shadow: var(--shadow); } .phone-confirm-modal-content .modal-buttons .confirm-no { background-color: var(--button-grey); color: var(--text-color); border: 1px solid var(--border-color); } .phone-confirm-modal-content .modal-buttons .confirm-no:hover { background-color: var(--button-grey-hover); box-shadow: var(--shadow); } /* New styles for location button */ .location-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; /* Adjust spacing as needed */ } .location-input-group textarea { flex-grow: 1; margin-bottom: 0; /* Remove default margin-bottom from textarea */ } .location-input-group button { background-color: var(--primary-color); color: #fff; border: none; padding: 12px 15px; font-size: 1rem; font-weight: 600; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; white-space: nowrap; display: flex; align-items: center; gap: 5px; } .location-input-group button:hover { background-color: #844; } .location-input-group button:disabled { background-color: var(--button-grey); color: var(--subtle-text-color); cursor: not-allowed; } .location-input-group button i { margin-left: 5px; } </style><style>.touch-slider::-webkit-scrollbar { display: none;}.touch-slider { -ms-overflow-style: none; scrollbar-width: none;}</style><style>#modalImageTrack { display: flex; overflow-x: auto; gap: 10px; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; touch-action: pan-x; padding-bottom: 10px; max-width: 100%; width: 100%; direction: rtl; /* Ensure RTL scrolling */}#modalImageTrack::-webkit-scrollbar { display: none;}#modalImageTrack img { max-height: 80vh; border-radius: 6px; scroll-snap-align: start; flex-shrink: 0; max-width: 100%; height: auto;}.image-modal-content { overflow: hidden; position: relative;}</style></head><body><div id="topControlsBar"><button class="menu-toggle-button" id="menuToggleButton" title="عرض أقسام المنتجات"><i class="fas fa-bars"></i></button><div class="mini-order-summary" id="miniOrderSummary"><i class="fas fa-shopping-cart"></i><span>اترس بيتك بدون ما تفرغ جيبك !</span></div></div><div id="dynamicCartSummaryBar"><div class="summary-header"><div class="summary-text"><span id="dynamicCartItemsCount"></span><span id="dynamicCartTotalAmount"></span></div><button class="confirm-order-button" id="dynamicConfirmOrderButton">اضغط لعرض الفاتورة</button></div></div><header><h1>عروض نفـــــيسه !</h1><h2 class="sub-heading">للعروض الخاصه و الاسعار التنافسيه !</h2></header><div class="slideshow-container"><img alt="Slide 1" class="mySlides" src="https://picsum.photos/id/1069/1200/250"/><img alt="Slide 2" class="mySlides" src="https://picsum.photos/id/1074/1200/250"/><img alt="Slide 3" class="mySlides" src="https://picsum.photos/id/1080/1200/250"/><a class="prev" onclick="plusSlides(-1)">❮</a><a class="next" onclick="plusSlides(1)">❯</a><div class="dots-container"><span class="dot" onclick="currentSlide(1)"></span><span class="dot" onclick="currentSlide(2)"></span><span class="dot" onclick="currentSlide(3)"></span></div><a class="prev" onclick="plusSlides(-1)">❮</a><a class="next" onclick="plusSlides(1)">❯</a></div><div class="sidebar-overlay" id="sidebarOverlay"></div><div class="container"><div class="main-wrapper"><div class="sidebar" id="sidebar"><button class="close-sidebar-button" id="closeSidebarButton" style="font-size: 1.5rem; color: #ccc;" title="إغلاق القائمة"><i class="fas fa-circle-xmark"></i></button><div class="sidebar-search"><i class="fas fa-search search-icon"></i><input id="sidebarProductSearchInput" placeholder="ابحث في المنتجات..."/><button class="voice-search-button" id="sidebarVoiceSearchButton" title="البحث بالصوت"><i class="fas fa-microphone"></i></button></div><div class="sidebar-categories"><div class="category-title">الأقسام</div><div class="category-list" id="categoryList"><button class="category-button active" data-category="all"><i class="fas fa-list"></i>الكل</button><button class="category-button" data-category="electronics"><i class="fas fa-laptop"></i>إلكترونيات</button><button class="category-button" data-category="home"><i class="fas fa-home"></i>منزل ومطبخ</button><button class="category-button" data-category="fashion"><i class="fas fa-tshirt"></i>موضة وإكسسوارات</button><button class="category-button" data-category="books"><i class="fas fa-book"></i>كتب وهوايات</button><button class="category-button" data-category="sports"><i class="fas fa-dumbbell"></i>رياضة</button><button class="category-button" data-category="tools"><i class="fas fa-tools"></i>أدوات</button><button class="category-button" data-category="beauty"><i class="fas fa-spa"></i>جمال وعناية</button><button class="category-button" data-category="art"><i class="fas fa-paint-brush"></i>فن وديكور</button></div></div></div><div class="content-area" id="contentArea"><div class="controls-above-products"><div class="search-bar"><i class="fas fa-search search-icon"></i><input id="searchInput" placeholder="ابحث في المنتجات..."/><button class="voice-search-button" id="mainVoiceSearchButton" title="البحث بالصوت"><i class="fas fa-microphone"></i></button></div><div class="sort-controls"><label for="sortButton">ترتيب حسب:</label><button class="sort-button" id="sortButton">الاختيار الافتراضي<i class="fas fa-sort"></i></button><select id="sortSelect" style="display:none"><option value="discount-desc">الاكثر خصما</option><option value="sales-desc">الأكثر مبيعاً</option><option value="price-asc">السعر: من الأقل للأعلى</option><option value="price-desc">السعر: من الأعلى للأقل</option></select></div></div><div class="products-grid" id="productsGrid"><div class="product-item" data-category="home" data-description="قدرة عائلية، شحن، 45 واط، منفذ شحن Type-C" data-image-id="9999" data-original-price="20000" data-price="11000" data-product-name="عصارة برتقال"><div class="product-slider touch-slider" data-images='["https://i.imgur.com/g9AtoDw.png", "https://i.imgur.com/eFJvzqv.png", "https://i.imgur.com/wNuUKad.png", "https://i.imgur.com/XZHY2Am.png"]' style="overflow-x: auto; display: flex; gap: 10px; scroll-snap-type: x mandatory;"><img src="https://i.imgur.com/g9AtoDw.png" alt="عصارة برتقال صورة 1" style="width: 100%; max-width: 300px; height: auto; scroll-snap-align: start; border-radius: 4px;"/><img src="https://i.imgur.com/eFJvzqv.png" alt="عصارة برتقال صورة 2" style="width: 100%; max-width: 300px; height: auto; scroll-snap-align: start; border-radius: 4px;"/><img src="https://i.imgur.com/wNuUKad.png" alt="عصارة برتقال صورة 3" style="width: 100%; max-width: 300px; height: auto; scroll-snap-align: start; border-radius: 4px;"/><img src="https://i.imgur.com/XZHY2Am.png" alt="عصارة برتقال صورة 4" style="width: 100%; max-width: 300px; height: auto; scroll-snap-align: start; border-radius: 4px;"/></div><div class="discount-badge"></div><span class="product-name">عصارة برتقال</span><p class="product-description">قدرة عائلية، شحن، 45 واط، منفذ شحن Type-C</p><span class="product-price"><span class="original-price"></span><span></span></span><button class="add-to-cart-button">اضغط للشراء<i class="fas fa-shopping-cart"></i></button><div class="quantity-control"><button class="decrease-quantity" type="button">-</button><input class="quantity-input" min="0" type="number" value="0"/><button class="increase-quantity" type="button">+</button></div></div><div class="product-item" data-category="other" data-description="منتج عملي وبسيط يلبي احتياجاتك اليومية بكفاءة." data-image-id="1044" data-original-price="20000" data-price="11000" data-product-name="منتج بسيط"><div class="discount-badge"></div><img alt="صورة منتج بسيط" src="https://picsum.photos/id/1044/300/150"/><span class="product-name">منتج بسيط</span><p class="product-description">منتج عملي وبسيط يلبي احتياجاتك اليومية بكفاءة.</p><span class="product-price"><span class="original-price"></span><span></span></span><button class="add-to-cart-button">اضغط للشراء<i class="fas fa-shopping-cart"></i></button><div class="quantity-control"><button class="decrease-quantity" type="button">-</button><input class="quantity-input" min="0" type="number" value="0"/><button class="increase-quantity" type="button">+</button></div></div></div><div class="order-summary" id="orderSummarySection"><button class="summary-toggle-button collapsed" id="toggleSummaryButton"><span>اكمال الطلب</span><i class="fas fa-chevron-down"></i></button><div id="collapsibleSummaryContent"><h2>تفاصيل الطلب</h2><div class="selected-items-list" id="selectedItemsList"></div><div class="free-delivery-message-summary" id="freeDeliveryMessageSummary" style="display:none"></div><div class="delivery-fee" id="deliveryFee" style="display:none"></div><div class="total-price" id="totalPrice">المجموع الإجمالي: 0 د. ع</div><form action="https://script.google.com/macros/s/AKfycbwjNezT0uu8TcZIGroso0bH20WU7Y6OksnwxBxHe5wB55Dq5i5BQDYrf9plGTO6g6J-fw/exec" id="myForm" method="POST"><textarea id="message" name="message" readonly="readonly" required="" rows="8" style="display:none"></textarea><button type="button" id="openOrderModalButton">تثبيت الطلب</button></form><div id="response"></div></div></div></div></div></div><div class="horizontal-categories" id="horizontalCategoryList"><button class="search-icon-button" id="horizontalSearchIcon" title="البحث عن منتج"><i class="fas fa-search"></i></button><div class="categories-scroll-wrapper"><button class="category-button active" data-category="all"><i class="fas fa-list"></i>الكل</button><button class="category-button" data-category="electronics"><i class="fas fa-laptop"></i>إلكترونيات</button><button class="category-button" data-category="home"><i class="fas fa-home"></i>منزل ومطبخ</button><button class="category-button" data-category="fashion"><i class="fas fa-tshirt"></i>موضة وإكسسوارات</button><button class="category-button" data-category="books"><i class="fas fa-book"></i>كتب وهوايات</button><button class="category-button" data-category="sports"><i class="fas fa-dumbbell"></i>رياضة</button><button class="category-button" data-category="tools"><i class="fas fa-tools"></i>أدوات</button><button class="category-button" data-category="beauty"><i class="fas fa-spa"></i>جمال وعناية</button><button class="category-button" data-category="art"><i class="fas fa-paint-brush"></i>فن وديكور</button></div></div><div class="free-delivery-alert-overlay" id="freeDeliveryAlertOverlay"><div class="free-delivery-alert-box"><button class="close-button" id="closeFreeDeliveryAlertButton">×</button><i class="fas fa-gift"></i><h3>تهانينا!</h3><p>لقد حصلت على توصيل مجاني!</p></div></div><div class="free-delivery-alert-overlay" id="freeDeliveryLostOverlay" style="background-color:rgba(0,0,0,.7)"><div class="free-delivery-alert-box" style="background-color:var(--surface-color)"><button class="close-button" id="closeFreeDeliveryLostAlertButton">×</button><i class="fas fa-frown" style="font-size:3rem;color:var(--danger-color);margin-bottom:15px"></i><h3>نأسف!</h3><p style="color:var(--danger-color);font-size:1.3rem;font-weight:700;margin-bottom:0">لقد فقدت التوصيل المجاني.</p></div></div><div class="image-modal-overlay" id="imageModalOverlay"><div class="image-modal-content"><button class="modal-close-button" id="closeImageModalButton">×</button><div id="modalImageTrack"></div><button class="modal-nav-arrow modal-nav-prev" id="modalNavPrev">❮</button><button class="modal-nav-arrow modal-nav-next" id="modalNavNext">❯</button><div class="image-modal-details"><h3 id="modalProductName"></h3><p class="modal-price"></p><p class="modal-description" id="modalProductDescription"></p></div><div class="quantity-control"><button class="decrease-quantity" type="button">-</button><input class="quantity-input" id="modalQuantityInput" min="0" type="number" value="0"/><button class="increase-quantity" type="button">+</button></div><button class="add-to-cart-button" id="modalAddToCartButton">اضغط للشراء<i class="fas fa-shopping-cart"></i></button><button class="done-button" id="modalDoneButton" style="display: none;">تم</button></div></div><div class="sort-modal-overlay" id="sortModalOverlay"><div class="sort-modal-content"><button class="modal-close-button" id="closeSortModalButton">×</button><h3>ترتيب المنتجات حسب:</h3><div class="sort-options"><button data-sort-value="discount-desc">الاكثر خصما</button><button data-sort-value="sales-desc">الأكثر مبيعاً</option><button data-sort-value="price-asc">السعر: من الأقل للأعلى</button><button data-sort-value="price-desc">السعر: من الأعلى للأقل</button></div></div></div><div class="confirm-delete-modal-overlay" id="confirmDeleteModalOverlay"><div class="confirm-delete-modal-content"><button class="modal-close-button" id="closeConfirmDeleteModalButton">×</button><h3>هل أنت متأكد من حذف المنتج؟</h3><div class="modal-buttons"><button class="modal-confirm-yes" id="modalConfirmDeleteYes">نعم، احذف</button><button class="modal-confirm-no" id="modalConfirmDeleteNo">إلغاء</button></div></div></div><div class="order-details-modal-overlay" id="orderDetailsModalOverlay"><div class="order-details-modal-content"><button class="modal-close-button" id="closeOrderDetailsModalButton">×</button><div class="modal-step active" id="step1"><h3>تأكيد الطلب - الخطوة 1 من 5</h3><label for="customerName">الاسم الكامل:</label><input type="text" id="customerName" placeholder="أدخل اسمك الكامل" required><div class="modal-error-message" id="nameError"></div><div class="modal-navigation"><button type="button" class="next-button" data-next-step="2">التالي</button></div></div><div class="modal-step" id="step2"><h3>تأكيد الطلب - الخطوة 2 من 5</h3><label for="phoneNumber">رقم الهاتف:</label><input type="tel" id="phoneNumber" placeholder="أدخل رقم الهاتف (مثال: 07xxxxxxxx)" required><div class="modal-error-message" id="phoneError"></div><div class="modal-navigation"><button type="button" class="prev-button" data-prev-step="1">السابق</button><button type="button" class="next-button" data-next-step="3" id="confirmPhoneButton">التالي</button></div></div><div class="modal-step" id="step3"><h3>تأكيد الطلب - الخطوة 3 من 5</h3><label for="backupPhoneNumber">رقم هاتف احتياطي (اختياري):</label><input type="tel" id="backupPhoneNumber" placeholder="أدخل رقم هاتف احتياطي"><div class="modal-navigation"><button type="button" class="prev-button" data-prev-step="2">السابق</button><button type="button" class="next-button" data-next-step="4">التالي</button></div></div><div class="modal-step" id="step4"><h3>تأكيد الطلب - الخطوة 4 من 5</h3><label for="governorateDisplay">المحافظة:</label><div id="governorateDisplay" style="padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; text-align: center; color: var(--subtle-text-color); cursor: pointer;">اختر المحافظة</div><div class="modal-error-message" id="governorateError"></div><div class="modal-navigation"><button type="button" class="prev-button" data-prev-step="3">السابق</button><button type="button" class="next-button" data-next-step="5">التالي</button></div></div><div class="modal-step" id="step5"><h3>تأكيد الطلب - الخطوة 5 من 5</h3><label for="address">العنوان التفصيلي:</label><div class="location-input-group"><textarea id="address" placeholder="الشارع، رقم المنزل، أقرب نقطة دالة" rows="4" required></textarea><button type="button" id="sendLocationButton" title="إرسال الموقع الحالي"><i class="fas fa-location-dot"></i> إرسال الموقع </button></div><div class="modal-error-message" id="addressError"></div><div class="modal-navigation"><button type="button" class="prev-button" data-prev-step="4">السابق</button><button type="button" class="submit-order-button">إرسال الطلب</button></div></div></div></div><div class="governorate-select-modal-overlay" id="governorateSelectModalOverlay"><div class="governorate-select-modal-content"><button class="modal-close-button" id="closeGovernorateSelectModalButton">×</button><h3>اختر المحافظة</h3><div class="governorate-list-grid" id="governorateListGrid"></div></div></div><div class="phone-confirm-modal-overlay" id="phoneConfirmModalOverlay"><div class="phone-confirm-modal-content"><button class="modal-close-button" id="closePhoneConfirmModalButton">×</button><h3>تأكيد رقم الهاتف</h3><p>هل أنت متأكد من رقم الهاتف هذا؟</p><span class="confirmed-phone-number" id="displayedPhoneNumber"></span><div class="modal-buttons"><button type="button" class="confirm-yes" id="phoneConfirmYes">نعم، متأكد</button><button type="button" class="confirm-no" id="phoneConfirmNo">لا، أريد التعديل</button></div></div></div><footer><p>تم التطوير بواسطة مجموعة ابن معدل التجارية | Developed by Ibn Muaddal Trading Group</p><p>© 1987-2025 All rights reserved | جميع الحقوق محفوظة</p></footer><script>
                let slideIndex = 1;
                showSlides(slideIndex);
                let slideshowTimer = setInterval((() => {
                    plusSlides(1)
                }), 3e3);
                const slideshowContainer = document.querySelector(".slideshow-container");
                slideshowContainer.addEventListener("mouseenter", (() => {
                    clearInterval(slideshowTimer)
                })), slideshowContainer.addEventListener("mouseleave", (() => {
                    slideshowTimer = setInterval(((() => {
                        plusSlides(1)
                    })), 3e3)
                }));
                let startX = 0, isDragging = !1;

                function plusSlides(e) {
                    showSlides(slideIndex += e)
                }
                function currentSlide(e) {
                    showSlides(slideIndex = e)
                }
                function showSlides(e) {
                    let t,
                    a = document.getElementsByClassName("mySlides"),
                    r = document.getElementsByClassName("dot");
                    for (e > a.length && (slideIndex = 1), e < 1 && (slideIndex = a.length), t = 0; t < a.length; t++) a[t].classList.remove("active-slide");
                    for (t = 0; t < r.length; t++) r[t].className = r[t].className.replace(" active-dot", "");
                    a[slideIndex - 1].classList.add("active-slide"),
                    r[slideIndex - 1].className += " active-dot"
                }

                slideshowContainer.addEventListener("mousedown", (e => {
                    startX = e.clientX, isDragging = !0, slideshowContainer.style.cursor = "grabbing"
                })),
                slideshowContainer.addEventListener("touchstart", (e => {
                    startX = e.touches[0].clientX, isDragging = !0
                })),
                slideshowContainer.addEventListener("mouseup", (e => {
                    if (!isDragging) return; isDragging = !1; slideshowContainer.style.cursor = "pointer"; const t = e.clientX - startX; Math.abs(t) > 50 && plusSlides(t > 0 ? -1: 1); startX = 0;
                })),
                slideshowContainer.addEventListener("touchend", (e => {
                    if (!isDragging) return; isDragging = !1; const t = e.changedTouches[0].clientX - startX; Math.abs(t) > 50 && plusSlides(t > 0 ? -1: 1); startX = 0;
                })),
                slideshowContainer.addEventListener("mousemove", (e => {
                    isDragging && e.preventDefault()
                }));

                const form = document.getElementById("myForm"), responseDiv = document.getElementById("response"),
                messageTextarea = document.getElementById("message"), productsGrid = document.getElementById("productsGrid"),
                totalPriceElement = document.getElementById("totalPrice"),
                selectedItemsList = document.getElementById("selectedItemsList"),
                miniOrderSummaryDiv = document.getElementById("miniOrderSummary"),
                toggleSummaryButton = document.getElementById("toggleSummaryButton"),
                searchInput = document.getElementById("searchInput"),
                sidebarProductSearchInput = document.getElementById("sidebarProductSearchInput"),
                sortSelect = document.getElementById("sortSelect"),
                sortButton = document.getElementById("sortButton"),
                sortModalOverlay = document.getElementById("sortModalOverlay"),
                closeSortModalButton = document.getElementById("closeSortModalButton"),
                sortOptions = document.querySelector(".sort-modal-content .sort-options"),
                sidebarCategoryList = document.getElementById("categoryList"),
                sidebarCategoryButtons = sidebarCategoryList.querySelectorAll(".category-button"),
                sidebar = document.getElementById("sidebar"), menuToggleButton = document.getElementById("menuToggleButton"),
                closeSidebarButton = document.getElementById("closeSidebarButton"),
                sidebarOverlay = document.getElementById("sidebarOverlay"),
                orderSummarySection = document.getElementById("orderSummarySection"),
                horizontalCategoryList = document.getElementById("horizontalCategoryList"),
                horizontalCategoryButtons = horizontalCategoryList.querySelectorAll(".category-button"),
                topControlsBar = document.getElementById("topControlsBar"),
                horizontalSearchIcon = document.getElementById("horizontalSearchIcon"),
                controlsAboveProducts = document.querySelector(".controls-above-products"),
                deliveryFeeElement = document.getElementById("deliveryFee"),
                freeDeliveryMessageSummaryElement = document.getElementById("freeDeliveryMessageSummary"),
                freeDeliveryAlertOverlay = document.getElementById("freeDeliveryAlertOverlay"),
                closeFreeDeliveryAlertButton = document.getElementById("closeFreeDeliveryAlertButton"),
                imageModalOverlay = document.getElementById("imageModalOverlay"),
                modalProductName = document.getElementById("modalProductName"),
                modalPrice = imageModalOverlay.querySelector(".modal-price"),
                closeImageModalButton = document.getElementById("closeImageModalButton"),
                modalQuantityInput = document.getElementById("modalQuantityInput"),
                modalDecreaseButton = imageModalOverlay.querySelector(".quantity-control .decrease-quantity"),
                modalIncreaseButton = imageModalOverlay.querySelector(".quantity-control .increase-quantity"),
                modalProductDescription = document.getElementById("modalProductDescription"),
                freeDeliveryLostOverlay = document.getElementById("freeDeliveryLostOverlay"),
                closeFreeDeliveryLostAlertButton = document.getElementById("closeFreeDeliveryLostAlertButton"),
                modalImageTrack = document.getElementById('modalImageTrack'),
                modalAddToCartButton = document.getElementById('modalAddToCartButton'),
                modalDoneButton = document.getElementById('modalDoneButton'); // New: Get the done button

                // New elements for dynamic cart summary bar
                const dynamicCartSummaryBar = document.getElementById('dynamicCartSummaryBar');
                const dynamicCartItemsCount = document.getElementById('dynamicCartItemsCount'); // Still needed for logic, but hidden
                const dynamicCartTotalAmount = document.getElementById('dynamicCartTotalAmount'); // Still needed for logic, but hidden
                const dynamicConfirmOrderButton = document.getElementById('dynamicConfirmOrderButton');
                let dynamicCartBarTimeout;


                let greenFlashTimeout, redFlashTimeout, previousTotalItemsCount = 0, currentCategory = "all";
                const DELIVERY_FEE = 5000;
                const FREE_DELIVERY_THRESHOLD = 3; // Number of products for free delivery
                let hasTriggeredFreeDeliveryAlert = !1, freeDeliveryAchieved = false;
                let productToConfirmDelete = null; // Variable to store the product name for confirmation

                const confirmDeleteModalOverlayElement = document.getElementById("confirmDeleteModalOverlay"),
                modalConfirmDeleteYesButton = document.getElementById("modalConfirmDeleteYes"),
                modalConfirmDeleteNoButton = document.getElementById("modalConfirmDeleteNo");
                const closeConfirmDeleteModalButton = document.getElementById("closeConfirmDeleteModalButton"); // New close button

                const mainVoiceSearchButton = document.getElementById("mainVoiceSearchButton"),
                sidebarVoiceSearchButton = document.getElementById("sidebarVoiceSearchButton");

                let recognition = null;
                let isListening = false;

                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognition = new SpeechRecognition();
                    recognition.continuous = false;
                    recognition.lang = 'ar-AE';
                    recognition.interimResults = false;
                    recognition.maxAlternatives = 1;

                    recognition.onstart = () => {
                        isListening = true;
                        mainVoiceSearchButton.classList.add('active');
                        sidebarVoiceSearchButton.classList.add('active');
                    };

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        searchInput.value = transcript;
                        sidebarProductSearchInput.value = transcript;
                        filterAndSortProducts();
                        isListening = false;
                        mainVoiceSearchButton.classList.remove('active');
                        sidebarVoiceSearchButton.classList.remove('active');
                    };

                    recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        isListening = false;
                        mainVoiceSearchButton.classList.remove('active');
                        sidebarVoiceSearchButton.classList.remove('active');
                    };

                    recognition.onend = () => {
                        isListening = false;
                        mainVoiceSearchButton.classList.remove('active');
                        sidebarVoiceSearchButton.classList.remove('active');
                    };

                    mainVoiceSearchButton.addEventListener('click', () => {
                        if (isListening) {
                            recognition.stop();
                        } else {
                            recognition.start();
                        }
                    });

                    sidebarVoiceSearchButton.addEventListener('click',
                        () => {
                            if (isListening) {
                                recognition.stop();
                            } else {
                                recognition.start();
                            }
                        });

                } else {
                    mainVoiceSearchButton.style.display = 'none';
                    sidebarVoiceSearchButton.style.display = 'none';
                }


                function getSanitizedQuantity(e) {
                    let t = parseInt(e);
                    return isNaN(t) || t < 0 ? 0: t
                }

                function getAllProductItems() {
                    return document.querySelectorAll(".product-item");
                }
                function getVisibleProductItems() {
                    return document.querySelectorAll(".product-item:not(.hidden)");
                }

                // Helper function to sync quantity between product item and modal/summary
                function syncProductState(productName) {
                    const productItem = document.querySelector(`.product-item[data-product-name="${productName}"]`);
                    if (!productItem) return;

                    const quantityInput = productItem.querySelector(".quantity-input");
                    const quantityControl = productItem.querySelector(".quantity-control");
                    const addButton = productItem.querySelector(".add-to-cart-button");
                    const currentQuantity = getSanitizedQuantity(quantityInput.value);

                    // Update product item display based on quantity
                    if (currentQuantity > 0) {
                        productItem.classList.add("in-cart");
                        if (quantityControl) quantityControl.style.display = 'flex';
                        if (addButton) addButton.style.display = 'none';
                    } else {
                        productItem.classList.remove("in-cart");
                        if (quantityControl) quantityControl.style.display = 'none';
                        if (addButton) addButton.style.display = 'flex';
                    }

                    // If modal is open for this product, sync its state
                    if (imageModalOverlay.classList.contains("visible") && imageModalOverlay.dataset.productName === productName) {
                        const modalQuantityInput = imageModalOverlay.querySelector("#modalQuantityInput");
                        const modalAddToCartButton = imageModalOverlay.querySelector("#modalAddToCartButton");
                        const modalQuantityControl = imageModalOverlay.querySelector(".image-modal-content .quantity-control");
                        const modalDoneButton = document.getElementById('modalDoneButton'); // Get done button inside modal

                        if (modalQuantityInput) modalQuantityInput.value = currentQuantity;

                        if (currentQuantity > 0) {
                            if (modalAddToCartButton) modalAddToCartButton.style.display = 'none';
                            if (modalQuantityControl) modalQuantityControl.style.display = 'flex';
                            if (modalDoneButton) modalDoneButton.style.display = 'flex'; // Show done button
                        } else {
                            if (modalAddToCartButton) modalAddToCartButton.style.display = 'flex';
                            if (modalQuantityControl) modalQuantityControl.style.display = 'none';
                            if (modalDoneButton) modalDoneButton.style.display = 'none'; // Hide done button
                        }
                    }

                    // renderOrderSummary will handle syncing with the summary list
                    renderOrderSummary();
                }


                function flashMiniSummary(e) {
                    const t = topControlsBar;
                    if (t) {
                        clearTimeout(greenFlashTimeout);
                        clearTimeout(redFlashTimeout);
                        t.classList.remove("item-added-glow", "item-removed-flash");
                        if (e) {
                            t.classList.add("item-added-glow");
                            greenFlashTimeout = setTimeout(() => {
                                t.classList.remove("item-added-glow");
                            }, 300);
                        } else {
                            t.classList.add("item-removed-flash");
                            redFlashTimeout = setTimeout(() => {
                                t.classList.remove("item-removed-flash");
                            }, 300);
                        }
                    }
                }

                // Modified flashButton function to handle different flash types
                function flashButton(element, type) {
                    if (!element) {
                        return;
                    }

                    let flashClass = '';
                    // Determine the flash class based on the type
                    if (type === 'green') flashClass = 'flash-green';
                    else if (type === 'red') flashClass = 'flash-red';
                    else if (type === 'skyblue') flashClass = 'flash-skyblue';
                    else if (type === 'pink') flashClass = 'flash-pink';
                    else {
                        return;
                    }

                    // Use requestAnimationFrame and a tiny timeout to ensure the browser registers the class change for animation
                    requestAnimationFrame(() => {
                        // Remove all potential flash classes before adding the new one
                        element.classList.remove("flash-green", "flash-red", "flash-skyblue", "flash-pink");

                        // Add the new flash class after a tiny delay
                        setTimeout(() => {
                            element.classList.add(flashClass);
                        }, 10); // A delay of 10ms is often sufficient

                        // Remove the flash class after the animation ends
                        // Use { once: true } to automatically remove the listener after it runs once
                        element.addEventListener('animationend', function handler() {
                            element.classList.remove(flashClass);
                            element.removeEventListener('animationend', handler);
                        }, {
                            once: true
                        });
                    });
                }


                function showFreeDeliveryAlert() {
                    if (!freeDeliveryAlertOverlay.classList.contains("visible")) {
                        freeDeliveryAlertOverlay.classList.add("visible");
                    }
                }

                function hideFreeDeliveryAlert() {
                    freeDeliveryAlertOverlay.classList.remove("visible");
                }


                function showFreeDeliveryLostAlert() {
                    if (!freeDeliveryLostOverlay.classList.contains("visible")) {
                        freeDeliveryLostOverlay.classList.add("visible");
                    }
                }

                function hideFreeDeliveryLostAlert() {
                    freeDeliveryLostOverlay.classList.remove("visible");
                }

                let modalSlideIndex = 0; // Current image index in the modal slider

                function showModalSlide(n) {
                    const track = document.getElementById('modalImageTrack');
                    const images = Array.from(track.children);
                    if (images.length === 0) return;

                    // Handle wrapping around
                    if (n >= images.length) {
                        modalSlideIndex = 0;
                    } else if (n < 0) {
                        modalSlideIndex = images.length - 1;
                    } else {
                        modalSlideIndex = n;
                    }

                    // Scroll to the correct image
                    // For RTL, scrollLeft 0 is the rightmost position.
                    // To scroll from right to left, we need to calculate the negative offset.
                    // Or, more simply, use scrollIntoView for consistent behavior.
                    images[modalSlideIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
                }

                function plusModalSlides(n) {
                    showModalSlide(modalSlideIndex + n);
                }


                function showImageModal(productName) {
                    const productItem = document.querySelector(`.product-item[data-product-name="${productName}"]`);
                    if (!productItem) return;

                    const price = parseFloat(productItem.dataset.price);
                    const originalPrice = parseFloat(productItem.dataset.originalPrice);
                    const description = productItem.dataset.description || "";
                    const quantity = getSanitizedQuantity(productItem.querySelector(".quantity-input").value);

                    // Clear previous images from the modal track
                    modalImageTrack.innerHTML = '';

                    // Check if the product has a product-slider (for multiple images)
                    const productSlider = productItem.querySelector('.product-slider');
                    let images = [];
                    if (productSlider && productSlider.dataset.images) {
                        images = JSON.parse(productSlider.dataset.images);
                    } else {
                        // Fallback to single image if no slider or data-images
                        const singleImage = productItem.querySelector('img');
                        if (singleImage) {
                            images.push(singleImage.src);
                        }
                    }

                    // Populate the modal image track with all images
                    images.forEach(url => {
                        const modalImg = document.createElement('img');
                        modalImg.src = url;
                        modalImg.alt = productName; // Set alt text for accessibility
                        modalImg.style = 'max-height: 80vh; border-radius: 6px; scroll-snap-align: start; flex-shrink: 0; max-width: 100%; height: auto;'; // Ensure height: auto for responsiveness
                        modalImageTrack.appendChild(modalImg);
                    });


                    modalProductName.textContent = productName;

                    let priceHTML = '';
                    // Display current price then original price next to it (for modal)
                    if (!isNaN(originalPrice) && originalPrice > price) {
                        const discountPercentage = Math.round(((originalPrice - price) / originalPrice) * 100);
                        priceHTML += `<span class="discount-badge">خصم ${discountPercentage}%</span>`;
                        priceHTML += `<span>${price.toLocaleString()} د. ع</span> <span class="original-price">${originalPrice.toLocaleString()} د. ع</span>`;
                    } else {
                        priceHTML += `<span>${price.toLocaleString()} د. ع !</span>`;
                    }
                    modalPrice.innerHTML = priceHTML;


                    modalProductDescription.textContent = description;
                    modalQuantityInput.value = quantity;

                    // Initial display logic for modal buttons
                    const modalQuantityControl = imageModalOverlay.querySelector(".image-modal-content .quantity-control");
                    const modalDoneButton = document.getElementById('modalDoneButton'); // Get done button inside modal

                    if (quantity > 0) {
                        modalAddToCartButton.style.display = 'none';
                        modalQuantityControl.style.display = 'flex';
                        modalDoneButton.style.display = 'flex'; // Show done button if quantity > 0
                    } else {
                        modalAddToCartButton.style.display = 'flex';
                        modalQuantityControl.style.display = 'none';
                        modalDoneButton.style.display = 'none'; // Hide done button if quantity is 0
                    }

                    imageModalOverlay.dataset.productName = productName;
                    imageModalOverlay.classList.add("visible");

                    // Reset modal slide index and show the first image when modal opens
                    modalSlideIndex = 0;
                    showModalSlide(modalSlideIndex);
                }

                function hideImageModal() {
                    imageModalOverlay.classList.remove("visible");
                    modalImageTrack.innerHTML = ''; // Clear image track
                    modalProductName.textContent = "";
                    modalPrice.textContent = "";
                    modalProductDescription.textContent = "";
                    modalQuantityInput.value = 0; // Reset modal quantity input
                    imageModalOverlay.removeAttribute("data-product-name");
                    modalDoneButton.style.display = 'none'; // Ensure done button is hidden on close
                }

                function updateMiniOrderSummaryContent(totalActiveItemsCount, totalActiveAmount) {
                    // Flash top bar when item is added/removed
                    totalActiveItemsCount > previousTotalItemsCount ? flashMiniSummary(true): totalActiveItemsCount < previousTotalItemsCount && flashMiniSummary(false);
                    previousTotalItemsCount = totalActiveItemsCount;

                    if (totalActiveItemsCount === 0) {
                        miniOrderSummaryDiv.innerHTML = '<i class="fas fa-shopping-cart"></i><span>اترس بيتك بدون ما تفرغ جيبك !</span>';
                        miniOrderSummaryDiv.classList.add("empty-state");
                    } else {
                        // Use toLocaleString() for better number formatting
                        miniOrderSummaryDiv.innerHTML = `<i class="fas fa-shopping-cart"></i><span>إجمالي القطع : ${totalActiveItemsCount}</span> | <span>المجموع: ${totalActiveAmount.toLocaleString()} د. ع</span>`;
                        miniOrderSummaryDiv.classList.remove("empty-state");
                    }

                    // Logic for displaying/hiding free delivery alert
                    const hadFreeDelivery = freeDeliveryAchieved; // Free delivery status before update

                    if (totalActiveItemsCount > 0 && totalActiveItemsCount >= FREE_DELIVERY_THRESHOLD) {
                        freeDeliveryAchieved = true;
                        if (!hadFreeDelivery && !hasTriggeredFreeDeliveryAlert) {
                            showFreeDeliveryAlert();
                            hasTriggeredFreeDeliveryAlert = true;
                        }
                    } else {
                        freeDeliveryAchieved = false;
                        if (hadFreeDelivery) {
                            showFreeDeliveryLostAlert();
                            hasTriggeredFreeDeliveryAlert = false;
                        }
                    }
                    if (totalActiveItemsCount === 0) {
                        hideFreeDeliveryAlert();
                        hideFreeDeliveryLostAlert();
                        hasTriggeredFreeDeliveryAlert = false;
                    }

                    // Update dynamic cart summary bar
                    updateDynamicCartSummaryBar(totalActiveItemsCount, totalActiveAmount);
                }


                function updateOrderSummary() {
                    let orderDetailsText = "تفاصيل الطلب:\n";
                    let totalActiveAmount = 0;
                    let totalActiveItemsCount = 0;

                    getAllProductItems().forEach(productItem => {
                        const productName = productItem.dataset.productName;
                        const price = parseFloat(productItem.dataset.price);
                        const quantityInput = productItem.querySelector(".quantity-input");
                        const quantity = getSanitizedQuantity(quantityInput ? quantityInput.value: 0);

                        if (quantity > 0) {
                            const subtotal = price * quantity;
                            const summaryItem = selectedItemsList.querySelector(`.summary-item[data-product-name="${productName}"]`);
                            const isSuspended = summaryItem ? summaryItem.dataset.suspended === "true": false;

                            // Only count active (non-suspended) items for total calculations
                            if (!isSuspended) {
                                totalActiveItemsCount += quantity;
                                totalActiveAmount += subtotal;
                            }

                            // Always include in the message, marking suspended items
                            orderDetailsText += `- ${productName}`;
                            orderDetailsText += ` (الكمية: ${quantity}, الاجمالي: ${subtotal.toLocaleString()} د. ع)`;
                            if (isSuspended) {
                                orderDetailsText += ` - [معلق]`;
                            }
                            orderDetailsText += `\n`;
                        }
                    });

                    if (totalActiveItemsCount === 0) {
                        orderDetailsText = "لم يتم اختيار أي منتجات نشطة بعد.\n";
                    }


                    let deliveryCost = 0;
                    if (totalActiveItemsCount > 0 && totalActiveItemsCount < FREE_DELIVERY_THRESHOLD) {
                        deliveryCost = DELIVERY_FEE;
                        deliveryFeeElement.textContent = `رسوم التوصيل: ${deliveryCost.toLocaleString()} د. ع`;
                        deliveryFeeElement.style.display = "block";
                        freeDeliveryMessageSummaryElement.style.display = "none";
                    } else if (totalActiveItemsCount >= FREE_DELIVERY_THRESHOLD) {
                        deliveryCost = 0;
                        deliveryFeeElement.style.display = "none";
                        freeDeliveryMessageSummaryElement.textContent = "مبروك! لقد حصلت على توصيل مجاني!";
                        freeDeliveryMessageSummaryElement.style.display = "block";
                    } else {
                        deliveryCost = 0;
                        deliveryFeeElement.style.display = "none";
                        freeDeliveryMessageSummaryElement.style.display = "none";
                    }


                    let finalTotal = totalActiveAmount + deliveryCost;


                    if (deliveryCost > 0) {
                        orderDetailsText += `\nرسوم التوصيل: ${deliveryCost.toLocaleString()} د. ع\n`;
                    } else if (totalActiveItemsCount >= FREE_DELIVERY_THRESHOLD && totalActiveItemsCount > 0) {
                        orderDetailsText += `\nالتوصيل: مجاني\n`;
                    }

                    orderDetailsText += `\nالمجموع الإجمالي المطلوب دفعه (للمنتجات النشطة ورسوم التوصيل): ${finalTotal.toLocaleString()} د. ع`;


                    messageTextarea.value = orderDetailsText.trim();
                    totalPriceElement.textContent = `المجموع الإجمالي: ${finalTotal.toLocaleString()} د. ع`;

                    updateMiniOrderSummaryContent(totalActiveItemsCount, finalTotal);
                }


                function renderOrderSummary() {
                    let hasItems = false;
                    const currentSummaryItems = {};

                    getAllProductItems().forEach(productItem => {
                        const productName = productItem.dataset.productName;
                        const price = parseFloat(productItem.dataset.price);
                        const quantityInput = productItem.querySelector(".quantity-input");
                        const quantity = getSanitizedQuantity(quantityInput.value);

                        if (quantity > 0) {
                            hasItems = true;
                            const existingSummaryItem = selectedItemsList.querySelector(`.summary-item[data-product-name="${productName}"]`);
                            const isSuspended = existingSummaryItem ? existingSummaryItem.dataset.suspended === "true": false;

                            let imageSrc = '';
                            const productSlider = productItem.querySelector('.product-slider');
                            if (productSlider && productSlider.dataset.images) {
                                const images = JSON.parse(productSlider.dataset.images);
                                imageSrc = images[0] || 'data:image/svg+xml;charset=UTF-8,<svg width=&quot;300&quot; height=&quot;150&quot; viewBox=&quot;0 0 300 150&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;><rect width=&quot;300&quot; height=&quot;150&quot; fill=&quot;#e0e0e0&quot;/><text x=&quot;50%&quot; y=&quot;50%&quot; font-family=&quot;Arial, sans-serif&quot; font-size=&quot;20&quot; fill=&quot;#9e9e90&quot; text-anchor=&quot;middle&quot; dy=&quot;.3em&quot;>نفيسه!</text></svg>';
                            } else {
                                const singleImage = productItem.querySelector('img');
                                imageSrc = singleImage ? singleImage.src : 'data:image/svg+xml;charset=UTF-8,<svg width=&quot;300&quot; height=&quot;150&quot; viewBox=&quot;0 0 300 150&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;><rect width=&quot;300&quot; height=&quot;150&quot; fill=&quot;#e0e0e0&quot;/><text x=&quot;50%&quot; y=&quot;50%&quot; font-family=&quot;Arial, sans-serif&quot; font-size=&quot;20&quot; fill=&quot;#9e9e90&quot; text-anchor=&quot;middle&quot; dy=&quot;.3em&quot;>نفيسه!</text></svg>';
                            }


                            currentSummaryItems[productName] = {
                                quantity: quantity,
                                isSuspended: isSuspended,
                                price: price,
                                imageSrc: imageSrc
                            };
                        }
                    });


                    selectedItemsList.innerHTML = "";

                    if (hasItems) {
                        for (const productName in currentSummaryItems) {
                            const itemData = currentSummaryItems[productName];
                            const subtotal = itemData.price * itemData.quantity;

                            let actionsHTML = '';
                            if (itemData.isSuspended) {
                                actionsHTML = `<button type="button" class="undo-suspend-button" data-product-name="${productName}" title="العودة عن الإيقاف"><i class="fas fa-undo-alt"></i></button><button type="button" class="confirm-final-delete-button" data-product-name="${productName}" title="حذف المنتج نهائياً"><i class="fas fa-trash-alt"></i></button>`;
                            } else {
                                actionsHTML = `<button type="button" class="suspend-item-button" data-product-name="${productName}" title="إيقاف المنتج"><i class="fas fa-ban"></i></button>`;
                            }

                            const listItemHTML = `
                            <div class="summary-item ${itemData.isSuspended ? "item-suspended": ""}" data-product-name="${productName}" data-price="${itemData.price}" ${itemData.isSuspended ? 'data-suspended="true"': ''}>
                            <img src="${itemData.imageSrc}" alt="${productName}" onerror="this.onerror=null; this.src='data:image/svg+xml;charset=UTF-8,<svg width=&quot;300&quot; height=&quot;150&quot; viewBox=&quot;0 0 300 150&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;><rect width=&quot;300&quot; height=&quot;150&quot; fill=&quot;#e0e0e0&quot;/><text x=&quot;50%&quot; y=&quot;50%&quot; font-family=&quot;Arial, sans-serif&quot; font-size=&quot;20&quot; fill=&quot;#9e9e90&quot; text-anchor=&quot;middle&quot; dy=&quot;.3em&quot;>نفيسه!</text></svg>'; this.classList.add('error-image');"/>
                            <div class="summary-item-details">
                            <span class="item-name">${productName}</span>
                            <span class="item-quantity">الكمية: ${itemData.quantity}</span>
                            <span class="item-unit-price">السعر: ${itemData.price.toLocaleString()} د. ع</span> <span class="item-subtotal">الاجمالي: ${subtotal.toLocaleString()} د. ع</span>
                            </div>
                            <div class="quantity-control summary-quantity-control">
                            <button type="button" class="decrease-quantity">-</button>
                            <input type="number" class="quantity-input summary-list-quantity-input" value="${itemData.quantity}" min="0" data-product-name="${productName}">
                            <button type="button" class="increase-quantity">+</button>
                            </div>
                            <div class="item-actions">
                            ${actionsHTML}
                            </div>
                            </div>
                            `;
                            selectedItemsList.innerHTML += listItemHTML;

                        }
                    } else {
                        selectedItemsList.innerHTML = '<p style="text-align: center; color: var(--subtle-text-color);">لم يتم اختيار أي منتجات بعد.</p>';
                    }

                    updateOrderSummary();
                }


                function filterAndSortProducts() {
                    const searchTerm = searchInput.value.toLowerCase().trim();
                    const category = currentCategory;

                    getAllProductItems().forEach(item => {
                        const productName = item.dataset.productName.toLowerCase();
                        const productCategory = item.dataset.category;
                        const productDescription = item.dataset.description ? item.dataset.description.toLowerCase(): "";

                        const matchesSearch = searchTerm === "" || productName.includes(searchTerm) || productDescription.includes(searchTerm);
                        const matchesCategory = category === "all" || productCategory === category;

                        if (matchesSearch && matchesCategory) {
                            item.classList.remove("hidden");
                        } else {
                            item.classList.add("hidden");
                        }
                    });
                    sortProducts();
                }

                function sortProducts() {
    const sortBy = sortSelect.value;
    const productItems = Array.from(getVisibleProductItems());

    productItems.sort((a, b) => {
        const priceA = parseFloat(a.dataset.price) || 0;
        const priceB = parseFloat(b.dataset.price) || 0;
        const originalPriceA = parseFloat(a.dataset.originalPrice) || priceA;
        const originalPriceB = parseFloat(b.dataset.originalPrice) || priceB;
        const salesA = parseInt(a.dataset.salesCount) || 0;
        const salesB = parseInt(b.dataset.salesCount) || 0;

        const percentageDiscountA = originalPriceA > priceA ? ((originalPriceA - priceA) / originalPriceA) * 100 : 0;
        const percentageDiscountB = originalPriceB > priceB ? ((originalPriceB - priceB) / originalPriceB) * 100 : 0;

        if (sortBy === "price-asc") {
            return priceA - priceB;
        } else if (sortBy === "price-desc") {
            return priceB - priceA;
        } else if (sortBy === "discount-desc") {
            return percentageDiscountB - percentageDiscountA;
        } else if (sortBy === "sales-desc") {
            return salesB - salesA;
        }
        return 0;
    });

    const fragment = document.createDocumentFragment();
    productItems.forEach(item => {
        fragment.appendChild(item);
    });
    productsGrid.appendChild(fragment);
}
                function showSortModal() {
                    sortModalOverlay.classList.add("visible");
                    const activeSortValue = sortSelect.value;
                    sortOptions.querySelectorAll('button').forEach(button => {
                        if (button.dataset.sortValue === activeSortValue) {
                            button.classList.add('active');
                        } else {
                            button.classList.remove('active');
                        }
                    });
                }

                function hideSortModal() {
                    sortModalOverlay.classList.remove("visible");
                }


                function showConfirmDeleteModal(productName) {
                    productToConfirmDelete = productName;
                    const confirmationMessage = `هل أنت متأكد من حذف المنتج "${productName}" نهائياً؟`;
                    confirmDeleteModalOverlayElement.querySelector('h3').textContent = confirmationMessage;

                    if (confirmDeleteModalOverlayElement) {
                        confirmDeleteModalOverlayElement.classList.add("visible");
                    }
                }

                function hideConfirmDeleteModal() {
                    if (confirmDeleteModalOverlayElement) {
                        confirmDeleteModalOverlayElement.classList.remove("visible");
                    }
                    productToConfirmDelete = null;
                }

                function handleConfirmDeleteYes() {
                    if (productToConfirmDelete) {
                        const productName = productToConfirmDelete;
                        const productItem = document.querySelector(`.product-item[data-product-name="${productName}"]`);

                        if (productItem) {
                            const quantityInput = productItem.querySelector(".quantity-input");

                            if (quantityInput) quantityInput.value = "0";

                            syncProductState(productName);

                            if (imageModalOverlay.classList.contains("visible") && imageModalOverlay.dataset.productName === productName) {
                                const modalQuantityInput = imageModalOverlay.querySelector("#modalQuantityInput");
                                if (modalQuantityInput) modalQuantityInput.value = "0";
                            }
                        } else {
                            console.error("Could not find product item to delete:", productName);
                        }

                        hideConfirmDeleteModal();
                    }
                }

                function handleConfirmDeleteNo() {
                    if (productToConfirmDelete) {
                        const productName = productToConfirmDelete;
                        const productItem = document.querySelector(`.product-item[data-product-name="${productName}"]`);
                        if (productItem) {
                            const quantityInput = productItem.querySelector(".quantity-input");
                            if (quantityInput) {
                                quantityInput.value = "1";
                                syncProductState(productName);

                                if (imageModalOverlay.classList.contains("visible") && imageModalOverlay.dataset.product-name === productName) {
                                    const modalQuantityInput = imageModalOverlay.querySelector("#modalQuantityInput");
                                    if (modalQuantityInput) modalQuantityInput.value = "1";
                                }
                            }
                        }
                    }
                    hideConfirmDeleteModal();
                }

                function selectCategory(category) {
                    currentCategory = category;
                    sidebarCategoryButtons.forEach(button => {
                        button.classList.remove("active");
                        if (button.dataset.category === category) {
                            button.classList.add("active");
                        }
                    });
                    horizontalCategoryButtons.forEach(button => {
                        button.classList.remove("active");
                        if (button.dataset.category === category) {
                            button.classList.add("active");
                        }
                    });


                    filterAndSortProducts();
                    closeSidebar();
                    if (controlsAboveProducts) {
                        controlsAboveProducts.scrollIntoView({
                            behavior: 'smooth', block: 'start'
                        });
                    }
                }

                function openSidebar() {
                    sidebar.classList.add("open");
                    sidebarOverlay.classList.add("visible");
                    menuToggleButton.style.display = "none";
                    horizontalCategoryList.classList.add("hidden-bar");
                    miniOrderSummaryDiv.style.display = "none";
                    dynamicCartSummaryBar.classList.remove('visible'); // Hide dynamic bar when sidebar opens
                }

                function closeSidebar() {
                    sidebar.classList.remove("open");
                    sidebarOverlay.classList.remove("visible");
                    menuToggleButton.style.display = "flex";
                    horizontalCategoryList.classList.remove("hidden-bar");
                    miniOrderSummaryDiv.style.display = "flex";
                }

                // --- Event Listeners ---

                closeFreeDeliveryLostAlertButton.addEventListener("click", hideFreeDeliveryLostAlert);
                freeDeliveryLostOverlay.addEventListener("click", function (e) {
                    if (e.target === freeDeliveryLostOverlay) {
                        hideFreeDeliveryLostAlert();
                    }
                });

                productsGrid.addEventListener("click", function (e) {
                    const target = e.target;
                    const productItem = target.closest(".product-item");

                    if (!productItem) return;

                    const productName = productItem.dataset.productName;
                    const quantityInput = productItem.querySelector(".quantity-input");
                    const addButton = productItem.querySelector(".add-to-cart-button");
                    const decreaseButton = target.closest(".decrease-quantity");
                    const increaseButton = target.closest(".increase-quantity");
                    let currentQuantity = getSanitizedQuantity(quantityInput.value);


                    if (target.closest(".add-to-cart-button")) {
                        quantityInput.value = 1;
                        syncProductState(productName);
                        flashButton(addButton, 'green');
                        return;
                    }

                    if (decreaseButton || increaseButton) {
                        const oldQuantity = currentQuantity;
                        let newQuantity = currentQuantity;

                        if (decreaseButton) {
                            if (currentQuantity > 0) newQuantity--;
                            flashButton(decreaseButton, 'red');
                        } else if (increaseButton) {
                            newQuantity++;
                            flashButton(increaseButton, 'green');
                        }

                        if (newQuantity === 0 && oldQuantity > 0) {
                            quantityInput.value = oldQuantity;
                            showConfirmDeleteModal(productName);
                        } else {
                            quantityInput.value = newQuantity;
                            syncProductState(productName);
                        }
                        return;
                    }

                    if (target.classList.contains("quantity-input")) {
                        return;
                    }

                    showImageModal(productName);
                });

                productsGrid.addEventListener("input", function (e) {
                    const target = e.target;
                    const productItem = target.closest(".product-item");
                    if (!productItem) return;

                    if (target.classList.contains("quantity-input")) {
                        clearTimeout(target.inputTimeout);
                        target.inputTimeout = setTimeout(() => {
                            const quantity = getSanitizedQuantity(target.value);
                            if (quantity === 0 && getSanitizedQuantity(productItem.querySelector(".quantity-input").value) > 0) {
                                target.value = getSanitizedQuantity(productItem.querySelector(".quantity-input").value);
                                showConfirmDeleteModal(productItem.dataset.productName);
                            } else {
                                target.value = quantity;
                                syncProductState(productItem.dataset.productName);
                            }
                        },
                            200);
                    }
                });

                productsGrid.addEventListener("change", function (e) {
                    const target = e.target;
                    const productItem = target.closest(".product-item");
                    if (!productItem) return;

                    if (target.classList.contains("quantity-input")) {
                        const quantity = getSanitizedQuantity(target.value);
                        if (quantity === 0 && getSanitizedQuantity(productItem.querySelector(".quantity-input").value) > 0) {
                            target.value = getSanitizedQuantity(productItem.querySelector(".quantity-input").value);
                            showConfirmDeleteModal(productItem.dataset.productName);
                        } else {
                            target.value = quantity;
                            productItem.querySelector(".quantity-input").value = quantity;
                            syncProductState(productItem.dataset.productName);
                        }
                    }
                });


                selectedItemsList.addEventListener("click", function (e) {
                    const target = e.target;
                    const button = target.closest("button");

                    if (!button) return;

                    const summaryItem = button.closest(".summary-item");
                    if (!summaryItem) return;

                    const productName = summaryItem.dataset.productName;
                    if (!productName) return;

                    const productItem = document.querySelector(`.product-item[data-product-name="${productName}"]`);
                    if (!productItem) {
                        console.error("Corresponding product item not found for summary item:", productName);
                        return;
                    }

                    const productQuantityInput = productItem.querySelector(".quantity-input");
                    if (!productQuantityInput) {
                        console.error("Quantity input not found for product item:", productName);
                        return;
                    }

                    let currentQuantity = getSanitizedQuantity(productQuantityInput.value);


                    if (button.classList.contains("suspend-item-button")) {
                        summaryItem.dataset.suspended = "true";
                        renderOrderSummary();
                    } else if (button.classList.contains("undo-suspend-button")) {
                        summaryItem.removeAttribute("data-suspended");
                        renderOrderSummary();
                    } else if (button.classList.contains("confirm-final-delete-button")) {
                        showConfirmDeleteModal(productName);
                    } else if (button.classList.contains("increase-quantity") || button.classList.contains("decrease-quantity")) {

                        let newQuantity = currentQuantity;
                        if (button.classList.contains("increase-quantity")) {
                            newQuantity++;
                            flashButton(button, 'green'); // Flash green for increase
                        } else if (button.classList.contains("decrease-quantity")) {
                            if (currentQuantity > 0) newQuantity--;
                            flashButton(button, 'red'); // Flash red for decrease
                        }

                        if (newQuantity === 0 && currentQuantity > 0) {
                            const summaryQuantityInput = summaryItem.querySelector(".quantity-input.summary-list-quantity-input");
                            if (summaryQuantityInput) summaryQuantityInput.value = newQuantity;

                            showConfirmDeleteModal(productName);
                        } else {
                            productQuantityInput.value = newQuantity;
                            syncProductState(productName);
                        }
                    }
                });

                selectedItemsList.addEventListener("change", function(e) {
                    const target = e.target;
                    if (target.classList.contains("quantity-input") && target.classList.contains("summary-list-quantity-input")) {
                        const summaryItem = target.closest(".summary-item");
                        if (!summaryItem) return;

                        const productName = summaryItem.dataset.productName;
                        const quantity = getSanitizedQuantity(target.value);

                        const productItem = document.querySelector(`.product-item[data-product-name="${productName}"]`);
                        if (!productItem) {
                            console.error("Could not find corresponding product item for summary change:", productName);
                            return;
                        }

                        if (quantity === 0 && getSanitizedQuantity(productItem.querySelector(".quantity-input").value) > 0) {
                            target.value = getSanitizedQuantity(productItem.querySelector(".quantity-input").value);
                            showConfirmDeleteModal(productName);
                        } else {
                            target.value = quantity;
                            productItem.querySelector(".quantity-input").value = quantity;
                            syncProductState(productName);
                        }
                    }
                });


                modalConfirmDeleteYesButton.addEventListener("click", handleConfirmDeleteYes);
                modalConfirmDeleteNoButton.addEventListener("click", handleConfirmDeleteNo);
                closeConfirmDeleteModalButton.addEventListener("click", hideConfirmDeleteModal);
                confirmDeleteModalOverlayElement.addEventListener("click", (e => {
                    if (e.target === confirmDeleteModalOverlayElement) {
                        hideConfirmDeleteModal();
                    }
                }));


                searchInput.addEventListener("input", function () {
                    sidebarProductSearchInput.value = this.value;
                    filterAndSortProducts();
                });

                sidebarProductSearchInput.addEventListener("input", function () {
                    searchInput.value = this.value;
                    filterAndSortProducts();
                });

                sortButton.addEventListener("click", showSortModal);

                sortOptions.addEventListener("click", function(e) {
                    const sortButton = e.target.closest("button");
                    if (sortButton && sortButton.dataset.sortValue) {
                        const selectedValue = sortButton.dataset.sortValue;
                        sortSelect.value = selectedValue;

                        sortOptions.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                        sortButton.classList.add('active');

                        const selectedText = sortOptions.querySelector(`button[data-sort-value="${selectedValue}"]`).textContent;
                        document.getElementById("sortButton").textContent = selectedText;
                        let sortIcon = document.getElementById("sortButton").querySelector('.fas.fa-sort');
                        if (!sortIcon) {
                            sortIcon = document.createElement('i');
                            sortIcon.classList.add('fas', 'fa-sort');
                            document.getElementById("sortButton").appendChild(sortIcon);
                        } else {
                            document.getElementById("sortButton").appendChild(sortIcon);
                        }


                        sortProducts();
                        hideSortModal();
                    }
                });

                closeSortModalButton.addEventListener("click", hideSortModal);
                sortModalOverlay.addEventListener("click", function(e) {
                    if (e.target === sortModalOverlay) {
                        hideSortModal();
                    }
                });


                sidebarCategoryList.addEventListener("click", function (e) {
                    const target = e.target.closest(".category-button");
                    if (target) {
                        const category = target.dataset.category;
                        if (category) {
                            selectCategory(category);
                            searchInput.value = "";
                            sidebarProductSearchInput.value = "";
                            if (controlsAboveProducts) {
                                controlsAboveProducts.scrollIntoView({
                                    behavior: 'smooth', block: 'start'
                                });
                            }
                        }
                    }
                });

                horizontalCategoryList.addEventListener("click", function (e) {
                    const target = e.target.closest(".category-button");
                    if (target) {
                        const category = target.dataset.category;
                        if (category) {
                            selectCategory(category);
                            searchInput.value = "";
                            sidebarProductSearchInput.value = "";
                            if (controlsAboveProducts) {
                                controlsAboveProducts.scrollIntoView({
                                    behavior: 'smooth', block: 'start'
                                });
                            }
                        }
                    }
                });


                toggleSummaryButton.addEventListener("click", function () {
                    orderSummarySection.classList.toggle("open");
                    toggleSummaryButton.classList.toggle("collapsed");
                    if (orderSummarySection.classList.contains("open")) {
                        orderSummarySection.scrollIntoView({
                            behavior: 'smooth', block: 'start'
                        });
                    }
                });

                miniOrderSummaryDiv.addEventListener("click", function() {
                    if (!orderSummarySection.classList.contains("open")) {
                        orderSummarySection.classList.add("open");
                        toggleSummaryButton.classList.remove("collapsed");
                    }
                    setTimeout(() => {
                        orderSummarySection.scrollIntoView({
                            behavior: 'smooth', block: 'start'
                        });
                    }, 500);
                });


                menuToggleButton.addEventListener("click", openSidebar);
                closeSidebarButton.addEventListener("click", closeSidebar);
                sidebarOverlay.addEventListener("click", closeSidebar);

                document.addEventListener("click", function (e) {
                    const isClickInsideSidebar = sidebar.contains(e.target);
                    const isClickOnMenuButton = menuToggleButton.contains(e.target);
                    const isClickInsideFreeDeliveryAlert = freeDeliveryAlertOverlay.contains(e.target);
                    const isClickInsideImageModal = imageModalOverlay.contains(e.target);
                    const isClickInsideOrderSummary = orderSummarySection.contains(e.target);
                    const isClickInsideSortModal = sortModalOverlay.contains(e.target);
                    const isClickInsideConfirmDeleteModal = confirmDeleteModalOverlayElement.contains(e.target);
                    const isClickInsideOrderDetailsModal = orderDetailsModalOverlay.contains(e.target);
                    const isClickInsideGovernorateSelectModal = governorateSelectModalOverlay.contains(e.target);
                    const isClickInsideDynamicCartBar = dynamicCartSummaryBar.contains(e.target);
                    const isClickInsidePhoneConfirmModal = phoneConfirmModalOverlay.contains(e.target);


                    if (!isClickInsideSidebar && !isClickOnMenuButton && sidebar.classList.contains("open") &&
                        !isClickInsideFreeDeliveryAlert && !isClickInsideImageModal && !isClickInsideOrderSummary && !isClickInsideSortModal && !isClickInsideConfirmDeleteModal && !isClickInsideOrderDetailsModal && !isClickInsideGovernorateSelectModal && !isClickInsideDynamicCartBar && !isClickInsidePhoneConfirmModal) {
                        closeSidebar();
                    }
                });


                document.body.addEventListener("focusin", function (e) {
                    if (e.target.classList.contains("quantity-input")) {
                        setTimeout(() => e.target.select(), 50);
                    }
                });

                horizontalSearchIcon.addEventListener("click", () => {
                    const mainSearchBar = document.getElementById("searchInput");
                    if (mainSearchBar && controlsAboveProducts) {
                        controlsAboveProducts.scrollIntoView({
                            behavior: 'smooth', block: 'start'
                        });
                        setTimeout(() => {
                            mainSearchBar.focus();
                        }, 300);
                    }
                });

                closeFreeDeliveryAlertButton.addEventListener("click", hideFreeDeliveryAlert);
                freeDeliveryAlertOverlay.addEventListener("click", function (e) {
                    if (e.target === freeDeliveryAlertOverlay) {
                        hideFreeDeliveryAlert();
                    }
                });

                closeImageModalButton.addEventListener("click", hideImageModal);
                imageModalOverlay.addEventListener("click", function (e) {
                    if ((e.target === imageModalOverlay || e.target.closest(".image-modal-content button.modal-close-button")) && !e.target.closest(".modal-nav-arrow")) {
                        hideImageModal();
                    }
                });

                imageModalOverlay.addEventListener("click", function (e) {
                    const target = e.target;
                    const decreaseButton = target.closest(".decrease-quantity");
                    const increaseButton = target.closest(".increase-quantity");

                    const modalQuantityInput = imageModalOverlay.querySelector("#modalQuantityInput");
                    if (!modalQuantityInput) return;

                    const productName = imageModalOverlay.dataset.productName;
                    const productItem = document.querySelector(`.product-item[data-product-name="${productName}"]`);

                    if (!productItem) return;

                    let currentQuantity = getSanitizedQuantity(modalQuantityInput.value);
                    let newQuantity = currentQuantity;

                    if (decreaseButton || increaseButton) {
                        const oldQuantity = currentQuantity;
                        if (decreaseButton) {
                            if (currentQuantity > 0) newQuantity--;
                            flashButton(decreaseButton, 'red');
                        } else if (increaseButton) {
                            newQuantity++;
                            flashButton(increaseButton, 'green');
                        }

                        if (newQuantity === 0 && oldQuantity > 0) {
                            modalQuantityInput.value = newQuantity;

                            showConfirmDeleteModal(productName);
                        } else {
                            modalQuantityInput.value = newQuantity;
                            productItem.querySelector(".quantity-input").value = newQuantity;
                            syncProductState(productName);
                        }
                    }
                });

                imageModalOverlay.addEventListener("input", function (e) {
                    const target = e.target;
                    const productName = imageModalOverlay.dataset.productName;
                    const productItem = document.querySelector(`.product-item[data-product-name="${productName}"]`);

                    if (!productItem) return;

                    if (target.classList.contains("quantity-input") && target.id === "modalQuantityInput") {
                        clearTimeout(target.inputTimeout);
                        target.inputTimeout = setTimeout(() => {
                            const quantity = getSanitizedQuantity(target.value);
                            if (quantity === 0 && getSanitizedQuantity(productItem.querySelector(".quantity-input").value) > 0) {
                                target.value = getSanitizedQuantity(productItem.querySelector(".quantity-input").value);
                                showConfirmDeleteModal(productName);
                            } else {
                                target.value = quantity;
                                productItem.querySelector(".quantity-input").value = quantity;
                                syncProductState(productName);
                            }
                        },
                            200);
                    }
                });

                imageModalOverlay.addEventListener("change", function (e) {
                    const target = e.target;
                    const productName = imageModalOverlay.dataset.productName;
                    const productItem = document.querySelector(`.product-item[data-product-name="${productName}"]`);

                    if (!productItem) return;

                    if (target.classList.contains("quantity-input") && target.id === "modalQuantityInput") {
                        const quantity = getSanitizedQuantity(target.value);
                        if (quantity === 0 && getSanitizedQuantity(productItem.querySelector(".quantity-input").value) > 0) {
                            target.value = getSanitizedQuantity(productItem.querySelector(".quantity-input").value);
                            showConfirmDeleteModal(productName);
                        } else {
                            target.value = quantity;
                            productItem.querySelector(".quantity-input").value = quantity;
                            syncProductState(productName);
                        }
                    }
                });

                // New: Add to Cart button in modal
                modalAddToCartButton.addEventListener('click', function() {
                    const productName = imageModalOverlay.dataset.productName;
                    if (productName) {
                        const productItem = document.querySelector(`.product-item[data-product-name="${productName}"]`);
                        if (productItem) {
                            const quantityInput = productItem.querySelector(".quantity-input");
                            quantityInput.value = 1; // Always set to 1 on initial add from modal
                            syncProductState(productName);
                            flashButton(modalAddToCartButton, 'green'); // Flash the modal button
                            // After adding to cart, hide the add to cart button and show quantity controls
                            modalAddToCartButton.style.display = 'none';
                            imageModalOverlay.querySelector(".image-modal-content .quantity-control").style.display = 'flex';
                            modalDoneButton.style.display = 'flex'; // Show done button
                        }
                    }
                });

                // New: Done button in modal
                modalDoneButton.addEventListener('click', hideImageModal);


                // Modal image navigation arrows
                document.getElementById('modalNavPrev').addEventListener('click', () => plusModalSlides(-1));
                document.getElementById('modalNavNext').addEventListener('click', () => plusModalSlides(1));


                let lastScrollTop = 0;
                const scrollThreshold = 50;

                function handleScroll() {
                    const scrollTop = window.scrollY || document.documentElement.scrollTop;

                    if (!sidebar.classList.contains('open')) {
                        if (scrollTop > lastScrollTop && scrollTop > scrollThreshold) {
                            horizontalCategoryList.classList.add("hidden-bar");
                        } else {
                            horizontalCategoryList.classList.remove("hidden-bar");
                        }
                    }

                    lastScrollTop = scrollTop <= 0 ? 0: scrollTop;
                }

                window.addEventListener("scroll", handleScroll);


                // --- Order Details Modal Logic ---
                const orderDetailsModalOverlay = document.getElementById('orderDetailsModalOverlay');
                const closeOrderDetailsModalButton = document.getElementById('closeOrderDetailsModalButton');
                // Updated to reflect new step IDs (no OTP)
                const orderDetailsModalSteps = [
                    document.getElementById('step1'),
                    document.getElementById('step2'),
                    document.getElementById('step3'), // Old step4
                    document.getElementById('step4'), // Old step5
                    document.getElementById('step5')  // Old step6
                ];
                const openOrderModalButton = document.getElementById('openOrderModalButton');
                const customerNameInput = document.getElementById('customerName');
                const phoneNumberInput = document.getElementById('phoneNumber');
                const backupPhoneNumberInput = document.getElementById('backupPhoneNumber');
                const governorateDisplay = document.getElementById('governorateDisplay');
                const addressInput = document.getElementById('address');
                const nameError = document.getElementById('nameError');
                const phoneError = document.getElementById('phoneError');
                const governorateError = document.getElementById('governorateError');
                const addressError = document.getElementById('addressError');
                const sendLocationButton = document.getElementById('sendLocationButton'); // New: Send Location Button

                // Phone Confirmation Modal elements
                const phoneConfirmModalOverlay = document.getElementById('phoneConfirmModalOverlay');
                const closePhoneConfirmModalButton = document.getElementById('closePhoneConfirmModalButton');
                const displayedPhoneNumber = document.getElementById('displayedPhoneNumber');
                const phoneConfirmYesButton = document.getElementById('phoneConfirmYes');
                const phoneConfirmNoButton = document.getElementById('phoneConfirmNo');
                const confirmPhoneButton = document.getElementById('confirmPhoneButton'); // The "Next" button on step2


                // Governorate Select Modal elements
                const governorateSelectModalOverlay = document.getElementById('governorateSelectModalOverlay');
                const closeGovernorateSelectModalButton = document.getElementById('closeGovernorateSelectModalButton');
                const governorateListGrid = document.getElementById('governorateListGrid');


                let currentStep = 1;
                const customerData = {
                    name: '',
                    phone: '',
                    backupPhone: '',
                    governorate: '',
                    address: ''
                };

                const iraqiGovernorates = [
                    "بغداد", "نينوى", "البصرة", "ذي قار", "بابل", "الأنبار", "كربلاء", "واسط",
                    "صلاح الدين", "ديالى", "المثنى", "النجف", "ميسان", "كركوك", "أربيل", "السليمانية", "دهوك"
                ];

                function populateGovernorateSelectModal() {
                    governorateListGrid.innerHTML = '';
                    iraqiGovernorates.forEach(gov => {
                        const button = document.createElement('button');
                        button.textContent = gov;
                        button.dataset.governorate = gov;
                        if (customerData.governorate === gov) {
                            button.classList.add('selected');
                        }
                        button.addEventListener('click', () => {
                            customerData.governorate = gov;
                            governorateDisplay.textContent = gov; // Update display in main modal
                            governorateDisplay.classList.add('selected'); // Add selected class for styling
                            hideGovernorateSelectModal();
                            // Clear error message if a governorate is selected
                            governorateError.textContent = '';
                        });
                        governorateListGrid.appendChild(button);
                    });
                }

                function showGovernorateSelectModal() {
                    populateGovernorateSelectModal();
                    governorateSelectModalOverlay.classList.add('visible');
                }

                function hideGovernorateSelectModal() {
                    governorateSelectModalOverlay.classList.remove('visible');
                }


                function showStep(stepNum) {
                    orderDetailsModalSteps.forEach((step, index) => {
                        const stepId = step.id;
                        let actualStepNum = parseInt(stepId.replace('step', ''));

                        if (actualStepNum === stepNum) {
                            step.classList.add('active');
                        } else {
                            step.classList.remove('active');
                        }
                    });
                    currentStep = stepNum;
                    // Clear previous errors when moving to a new step
                    nameError.textContent = '';
                    phoneError.textContent = '';
                    governorateError.textContent = '';
                    addressError.textContent = '';
                }

                function validateStep(step) {
                    let isValid = true;
                    if (step === 1) {
                        if (customerNameInput.value.trim() === '') {
                            nameError.textContent = 'الاسم مطلوب.';
                            isValid = false;
                        } else {
                            nameError.textContent = '';
                        }
                    } else if (step === 2) {
                        const phone = phoneNumberInput.value.trim();
                        // Basic phone number validation (e.g., starts with 07 and has 11 digits)
                        if (phone === '') {
                            phoneError.textContent = 'رقم الهاتف مطلوب.';
                            isValid = false;
                        } else if (!/^07[0-9]{9}$/.test(phone)) {
                            phoneError.textContent = 'صيغة رقم الهاتف غير صحيحة (مثال: 07xxxxxxxx).';
                            isValid = false;
                        } else {
                            phoneError.textContent = '';
                            customerData.phone = phone; // Save phone number if valid
                        }
                    } else if (step === 4) { // Governorate step (now step 4)
                        if (customerData.governorate.trim() === '') {
                            governorateError.textContent = 'الرجاء اختيار المحافظة.';
                            isValid = false;
                        } else {
                            governorateError.textContent = '';
                        }
                    } else if (step === 5) { // Address step (now step 5)
                        if (addressInput.value.trim() === '') {
                            addressError.textContent = 'العنوان مطلوب.';
                            isValid = false;
                        } else {
                            addressError.textContent = '';
                        }
                    }
                    return isValid;
                }

                function nextStep() {
                    if (validateStep(currentStep)) {
                        // Special handling for step 2: show phone confirmation modal
                        if (currentStep === 2) {
                            showPhoneConfirmModal(customerData.phone);
                        } else {
                            // Save data for current step before moving
                            if (currentStep === 1) customerData.name = customerNameInput.value.trim();
                            if (currentStep === 3) customerData.backupPhone = backupPhoneNumberInput.value.trim();
                            if (currentStep === 5) customerData.address = addressInput.value.trim();

                            if (currentStep < orderDetailsModalSteps.length) {
                                showStep(currentStep + 1);
                            }
                        }
                    }
                }

                function prevStep() {
                    if (currentStep > 1) {
                        showStep(currentStep - 1);
                    }
                }

                function closeOrderDetailsModal() {
                    orderDetailsModalOverlay.classList.remove('visible');
                    // Reset modal state
                    showStep(1);
                    customerNameInput.value = '';
                    phoneNumberInput.value = '';
                    backupPhoneNumberInput.value = '';
                    governorateDisplay.textContent = 'اختر المحافظة'; // Reset display
                    governorateDisplay.classList.remove('selected'); // Remove selected class
                    addressInput.value = '';
                    nameError.textContent = '';
                    phoneError.textContent = '';
                    governorateError.textContent = '';
                    addressError.textContent = '';
                    customerData.name = '';
                    customerData.phone = '';
                    customerData.backupPhone = '';
                    customerData.governorate = '';
                    customerData.address = '';
                }

                // Phone Confirmation Modal Functions
                function showPhoneConfirmModal(phone) {
                    displayedPhoneNumber.textContent = phone;
                    phoneConfirmModalOverlay.classList.add('visible');
                }

                function hidePhoneConfirmModal() {
                    phoneConfirmModalOverlay.classList.remove('visible');
                }

                openOrderModalButton.addEventListener('click', () => {
                    let totalActiveItems = 0;
                    getAllProductItems().forEach(productItem => {
                        const quantityInput = productItem.querySelector(".quantity-input");
                        const quantity = getSanitizedQuantity(quantityInput ? quantityInput.value: 0);
                        const summaryItem = selectedItemsList.querySelector(`.summary-item[data-product-name="${productItem.dataset.productName}"]`);
                        const isSuspended = summaryItem ? summaryItem.dataset.suspended === "true": false;

                        if (quantity > 0 && !isSuspended) {
                            totalActiveItems += quantity;
                        }
                    });

                    if (totalActiveItems === 0) {
                        responseDiv.textContent = "الرجاء إضافة منتجات (نشطة) إلى السلة قبل تثبيت الطلب.";
                        responseDiv.className = "error";
                        return;
                    }

                    orderDetailsModalOverlay.classList.add('visible');
                    showStep(1); // Always start from step 1
                });

                closeOrderDetailsModalButton.addEventListener('click', closeOrderDetailsModal);
                orderDetailsModalOverlay.addEventListener('click', (e) => {
                    if (e.target === orderDetailsModalOverlay) {
                        closeOrderDetailsModal();
                    }
                });

                // Event delegation for modal navigation buttons
                orderDetailsModalOverlay.addEventListener('click', (e) => {
                    if (e.target.classList.contains('next-button')) {
                        nextStep();
                    } else if (e.target.classList.contains('prev-button')) {
                        prevStep();
                    } else if (e.target.classList.contains('submit-order-button')) {
                        if (validateStep(currentStep)) {
                            customerData.address = addressInput.value.trim(); // Save last step data
                            submitOrder();
                        }
                    }
                });

                // Event listener for the governorateDisplay div itself
                governorateDisplay.addEventListener('click', showGovernorateSelectModal);
                closeGovernorateSelectModalButton.addEventListener('click', hideGovernorateSelectModal);
                governorateSelectModalOverlay.addEventListener('click', (e) => {
                    if (e.target === governorateSelectModalOverlay) {
                        hideGovernorateSelectModal();
                    }
                });

                // Phone confirmation modal button listeners
                phoneConfirmYesButton.addEventListener('click', () => {
                    hidePhoneConfirmModal();
                    // Proceed to the next step (old step4, now step3)
                    showStep(3);
                });

                phoneConfirmNoButton.addEventListener('click', () => {
                    hidePhoneConfirmModal();
                    // Stay on step 2 (phone number input)
                    showStep(2);
                });

                closePhoneConfirmModalButton.addEventListener('click', () => {
                    hidePhoneConfirmModal();
                    showStep(2); // Go back to phone input if user closes modal
                });

                phoneConfirmModalOverlay.addEventListener('click', (e) => {
                    if (e.target === phoneConfirmModalOverlay) {
                        hidePhoneConfirmModal();
                        showStep(2); // Go back to phone input if user clicks outside
                    }
                });

                // New: Send Location Button Logic
                sendLocationButton.addEventListener('click', () => {
                    if ("geolocation" in navigator) {
                        sendLocationButton.disabled = true;
                        sendLocationButton.textContent = 'جاري الحصول على الموقع...';
                        addressError.textContent = ''; // Clear previous errors

                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const lat = position.coords.latitude;
                                const lon = position.coords.longitude;
                                const googleMapsLink = `https://www.google.com/maps?q=${lat},${lon}`;
                                addressInput.value = `الموقع: ${lat}, ${lon} (رابط الخريطة: ${googleMapsLink})`;
                                sendLocationButton.disabled = false;
                                sendLocationButton.innerHTML = '<i class="fas fa-location-dot"></i> تم الحصول على الموقع';
                                flashButton(sendLocationButton, 'green');
                            },
                            (error) => {
                                sendLocationButton.disabled = false;
                                sendLocationButton.innerHTML = '<i class="fas fa-location-dot"></i> إرسال الموقع';
                                flashButton(sendLocationButton, 'red');
                                switch (error.code) {
                                    case error.PERMISSION_DENIED:
                                        addressError.textContent = "تم رفض إذن الموقع. الرجاء السماح بالوصول إلى الموقع في إعدادات المتصفح.";
                                        break;
                                    case error.POSITION_UNAVAILABLE:
                                        addressError.textContent = "معلومات الموقع غير متوفرة.";
                                        break;
                                    case error.TIMEOUT:
                                        addressError.textContent = "انتهت مهلة طلب الموقع.";
                                        break;
                                    default:
                                        addressError.textContent = "حدث خطأ غير معروف أثناء الحصول على الموقع.";
                                        break;
                                }
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0
                            }
                        );
                    } else {
                        addressError.textContent = "الموقع الجغرافي غير مدعوم في متصفحك.";
                    }
                });


                function submitOrder() {
                    // Final validation before submission
                    if (!validateStep(5)) { // Validate the last step (Address)
                        return;
                    }

                    // Construct the full message for the Google Sheet
                    let fullOrderMessage = `\n--- معلومات العميل ---\n`;
                    fullOrderMessage += `الاسم: ${customerData.name}\n`;
                    fullOrderMessage += `رقم الهاتف: ${customerData.phone} (تم التأكيد يدوياً)\n`; // Indicate manual confirmation
                    if (customerData.backupPhone) {
                        fullOrderMessage += `رقم احتياطي: ${customerData.backupPhone}\n`;
                    }
                    fullOrderMessage += `المحافظة: ${customerData.governorate}\n`;
                    fullOrderMessage += `العنوان: ${customerData.address}\n\n`;
                    fullOrderMessage += messageTextarea.value; // Append existing order details

                    const formData = new FormData();
                    formData.append('message', fullOrderMessage); // Use 'message' as the field name for the Google Sheet

                    const scriptURL = form.action; // Get the action URL from the form

                    responseDiv.textContent = "جاري إرسال الطلب...";
                    responseDiv.className = "";
                    const oldWhatsappButton = responseDiv.querySelector('.whatsapp-button');
                    if (oldWhatsappButton) {
                        oldWhatsappButton.remove();
                    }

                    fetch(scriptURL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams(formData).toString() // Convert FormData to URL-encoded string
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.result === 'success') {
                            responseDiv.textContent = "تم إرسال الطلب بنجاح إلى نظام المتجر!";
                            responseDiv.className = "success";

                            const whatsappButton = document.createElement('button');
                            whatsappButton.classList.add('whatsapp-button');
                            whatsappButton.innerHTML = '<i class="fab fa-whatsapp"></i> إرسال الطلب عبر الواتس اب';
                            whatsappButton.type = 'button';

                            whatsappButton.addEventListener('click', () => {
                                const whatsappNumber = '9647727282886';
                                const whatsappMessage = encodeURIComponent(`مرحباً، أود طلب المنتجات التالية:\n\n${fullOrderMessage}`);

                                const whatsappURL = `https://wa.me/${whatsappNumber}?text=${whatsappMessage}`;
                                window.open(whatsappURL, '_blank');

                                // Reset UI state after opening WhatsApp
                                form.reset();
                                getAllProductItems().forEach(item => {
                                    const quantityInput = item.querySelector(".quantity-input");
                                    if (quantityInput) quantityInput.value = "0";
                                    syncProductState(item.dataset.productName);
                                });

                                hasTriggeredFreeDeliveryAlert = false;
                                freeDeliveryAchieved = false;
                                previousTotalItemsCount = 0;
                                renderOrderSummary();
                                hideFreeDeliveryAlert();
                                hideFreeDeliveryLostAlert();
                                searchInput.value = "";
                                sidebarProductSearchInput.value = "";
                                sortSelect.value = "default";
                                const defaultSortButton = sortOptions.querySelector('button[data-sort-value="default"]');
                                if (defaultSortButton) {
                                    document.getElementById("sortButton").textContent = defaultSortButton.textContent;
                                    let sortIcon = document.getElementById("sortButton").querySelector('.fas.fa-sort');
                                    if (!sortIcon) {
                                        sortIcon = document.createElement('i');
                                        sortIcon.classList.add('fas', 'fa-sort');
                                        document.getElementById("sortButton").appendChild(sortIcon);
                                    } else {
                                        document.getElementById("sortButton").appendChild(sortIcon);
                                    }
                                }
                                selectCategory("all");
                                closeSidebar();
                                orderSummarySection.classList.remove("open");
                                toggleSummaryButton.classList.add("collapsed");

                                whatsappButton.remove();
                            });

                            responseDiv.appendChild(whatsappButton);
                            closeOrderDetailsModal(); // Close the order details modal after successful submission
                        } else {
                            responseDiv.textContent = "حدث خطأ أثناء الإرسال: " + (data.message || "خطأ غير معروف.");
                            responseDiv.className = "error";
                        }
                    })
                    .catch(error => {
                        responseDiv.textContent = "حدث خطأ أثناء الاتصال: " + error.message;
                        responseDiv.className = "error";
                    });
                }

                // Dynamic Cart Summary Bar Logic
                function updateDynamicCartSummaryBar(totalItems, totalAmount) {
                    clearTimeout(dynamicCartBarTimeout); // Clear any existing timeout

                    if (totalItems > 0) {
                        // dynamicCartItemsCount.textContent = `تم إضافة ${totalItems} منتج`; // Hidden
                        // dynamicCartTotalAmount.textContent = `المجموع: ${totalAmount.toLocaleString()} د. ع`; // Hidden
                        dynamicCartSummaryBar.classList.add('visible');

                        // Set timeout to hide the bar after 3 seconds
                        dynamicCartBarTimeout = setTimeout(() => {
                            dynamicCartSummaryBar.classList.remove('visible');
                        }, 3000); // Changed from 5000 to 3000
                    } else {
                        dynamicCartSummaryBar.classList.remove('visible');
                    }
                }

                // Keep dynamic bar visible on mouse enter, hide on mouse leave
                dynamicCartSummaryBar.addEventListener('mouseenter', () => {
                    clearTimeout(dynamicCartBarTimeout);
                });

                dynamicCartSummaryBar.addEventListener('mouseleave', () => {
                    // Check if there are items before setting timeout to hide
                    const totalItems = Array.from(getAllProductItems()).reduce((sum, item) => sum + getSanitizedQuantity(item.querySelector(".quantity-input").value), 0);
                    if (totalItems > 0) {
                        dynamicCartBarTimeout = setTimeout(() => {
                            dynamicCartSummaryBar.classList.remove('visible');
                        }, 3000); // Changed from 5000 to 3000
                    }
                });

                // Link dynamic bar's confirm button to scroll to order summary section
                dynamicConfirmOrderButton.addEventListener('click', () => {
                    dynamicCartSummaryBar.classList.remove('visible'); // Hide the dynamic bar immediately
                    orderSummarySection.classList.add("open"); // Ensure summary section is open
                    toggleSummaryButton.classList.remove("collapsed"); // Ensure toggle button reflects open state
                    setTimeout(() => {
                        orderSummarySection.scrollIntoView({
                            behavior: 'smooth', block: 'start'
                        });
                    }, 100); // Small delay to allow CSS transition
                });


                document.addEventListener("DOMContentLoaded", () => {
                    if (window.scrollY <= scrollThreshold) {
                        horizontalCategoryList.classList.add("hidden-bar");
                    }

                    getAllProductItems().forEach(item => { syncProductState(item.dataset.productName); });


                    renderOrderSummary();
                    filterAndSortProducts();
                });

                // Function to format price (moved from separate script block)
                function formatPrice(price) {
                    return price.toLocaleString('en-US') + ' د.ع';
                }

                document.addEventListener("DOMContentLoaded", function () {
                    const products = document.querySelectorAll(".product-item");

                    products.forEach(item => {
                        const price = parseInt(item.dataset.price, 10);
                        const originalPrice = parseInt(item.dataset.originalPrice, 10);

                        const priceContainer = item.querySelector(".product-price span:last-child");
                        const originalPriceContainer = item.querySelector(".product-price .original-price");
                        const discountBadge = item.querySelector(".discount-badge");

                        if (!isNaN(price)) {
                            // Ensure the current price is set
                            priceContainer.textContent = formatPrice(price);
                        }

                        if (!isNaN(originalPrice) && originalPrice > price) {
                            // If there's an original price, display it above the current price
                            originalPriceContainer.textContent = formatPrice(originalPrice);
                            originalPriceContainer.style.display = 'block'; // Ensure it's block for stacking
                            const discountPercentage = Math.round(((originalPrice - price) / originalPrice) * 100);
                            discountBadge.textContent = `خصم ${discountPercentage}%`;
                            discountBadge.style.display = 'inline-block'; // Ensure badge is visible
                        } else {
                            originalPriceContainer.style.display = 'none'; // Hide original price if not applicable
                            discountBadge.style.display = 'none'; // Hide discount badge if not applicable
                        }
                    });
                });

                // Product slider image click listener (moved from separate script block)
                document.querySelectorAll('.product-slider img').forEach(img => {
                    img.style.cursor = 'pointer';
                    img.addEventListener('click', () => {
                        const slider = img.closest('.product-slider');
                        const imagesAttr = slider.getAttribute('data-images');
                        if (!imagesAttr) return;
                        const images = JSON.parse(imagesAttr);
                        const clickedSrc = img.getAttribute('src');
                        const modal = document.getElementById('imageModalOverlay');
                        const track = document.getElementById('modalImageTrack');
                        track.innerHTML = '';

                        images.forEach((url) => {
                            const modalImg = document.createElement('img');
                            modalImg.src = url;
                            modalImg.style = 'max-height: 80vh; border-radius: 6px; scroll-snap-align: start; flex-shrink: 0; max-width: 100%; height: auto;';
                            track.appendChild(modalImg);
                        });

                        modal.classList.add('visible');
                        const index = images.indexOf(clickedSrc);
                        if (index >= 0 && track.children[index]) {
                            track.children[index].scrollIntoView({ behavior: 'instant', block: 'nearest', inline: 'start' });
                            modalSlideIndex = index; // Set the modalSlideIndex to the current image
                        }

                        const productItem = slider.closest('.product-item');
                        if (productItem) {
                            const productName = productItem.dataset.productName;
                            const price = parseFloat(productItem.dataset.price);
                            const originalPrice = parseFloat(productItem.dataset.originalPrice);
                            const description = productItem.dataset.description || "";
                            const quantity = parseInt(productItem.querySelector(".quantity-input").value) || 0;

                            document.getElementById('modalProductName').textContent = productName;
                            let priceHTML = '';
                            if (!isNaN(originalPrice) && originalPrice > price) {
                                const discountPercentage = Math.round(((originalPrice - price) / originalPrice) * 100);
                                priceHTML += `<span class="discount-badge">خصم ${discountPercentage}%</span>`;
                                priceHTML += `<span>${price.toLocaleString()} د. ع</span> <span class="original-price">${originalPrice.toLocaleString()} د. ع</span>`;
                            } else {
                                priceHTML += `<span>${price.toLocaleString()} د. ع !</span>`;
                            }
                            document.querySelector('#imageModalOverlay .modal-price').innerHTML = priceHTML;
                            document.getElementById('modalProductDescription').textContent = description;
                            document.getElementById('modalQuantityInput').value = quantity;
                            modal.dataset.productName = productName;

                            const modalAddToCartButton = document.getElementById('modalAddToCartButton');
                            const modalQuantityControl = document.querySelector('.image-modal-content .quantity-control');
                            const modalDoneButton = document.getElementById('modalDoneButton'); // Get the done button

                            if (quantity > 0) {
                                modalAddToCartButton.style.display = 'none';
                                modalQuantityControl.style.display = 'flex';
                                modalDoneButton.style.display = 'flex'; // Show done button
                            } else {
                                modalAddToCartButton.style.display = 'flex';
                                modalQuantityControl.style.display = 'none';
                                modalDoneButton.style.display = 'none'; // Hide done button
                            }
                        }
                    });
                });

                // closeProductModal function (moved from separate script block)
                function closeProductModal() {
                    document.getElementById('imageModalOverlay').classList.remove('visible');
                    document.getElementById('modalImageTrack').innerHTML = '';
                    document.getElementById('modalProductName').textContent = '';
                    document.querySelector('#imageModalOverlay .modal-price').innerHTML = '';
                    document.getElementById('modalProductDescription').textContent = '';
                    document.getElementById('modalQuantityInput').value = 0;
                    document.getElementById('imageModalOverlay').removeAttribute('data-product-name');
                    modalSlideIndex = 0; // Reset slide index when modal closes
                    modalDoneButton.style.display = 'none'; // Ensure done button is hidden on close
                }

                document.getElementById('closeImageModalButton').addEventListener('click', closeProductModal);

                document.getElementById('imageModalOverlay').addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeProductModal();
                    }
                });
</script></body></html>
